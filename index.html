<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INNERLY | Premium Emotional Balance</title>

    <!-- SECURITY META TAGS -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XEELZR1L2D"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XEELZR1L2D');
    </script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Plus+Jakarta+Sans:wght@700;800&display=swap" rel="stylesheet">
    
    <!-- Icons, Markdown & Security Libs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <!-- Three.js (Version r128 - Stable) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        :root {
            --p-blue: #3B82F6;
            --p-blue-soft: #F0F8FF;
            --p-pink: #FFB7C5;
            --p-pink-soft: #FFF0F3;
            --p-mint: #B2F2BB;
            --p-mint-soft: #EBFBEE;
            --p-yellow: #FFE066;
            --p-yellow-soft: #FFF9DB;
            --p-orange: #FF922B;
            --error-red: #EF4444;
            --success-green: #10B981;
            
            --slate-900: #0F172A;
            --slate-800: #1E293B;
            --slate-600: #475569;
            --white: #ffffff;
            --shadow-p: 0 10px 30px -5px rgba(0, 0, 0, 0.08);
            --radius-lg: 32px;
        }

        /* --- BASIC RESET --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--white); 
            color: var(--slate-800);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        h1, h2, h3, .logo span { font-family: 'Plus Jakarta Sans', sans-serif; }
        .container { width: 100%; max-width: 1240px; margin: 0 auto; padding: 0 2rem; }

        /* --- 3D MASCOT --- */
        #mascot-3d-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px; 
            height: 380px;
            z-index: 3000;
            pointer-events: none;
            transition: all 0.5s ease;
        }
        @media (max-width: 850px) {
            #mascot-3d-container { 
                width: 160px; height: 190px; 
                bottom: 10px; right: 10px;
                opacity: 0.8;
            }
        }

        #three-canvas { width: 100%; height: 100%; pointer-events: auto; cursor: pointer; transition: 0.3s; }

        .mascot-bubble {
            position: absolute; top: 40px; right: 60px; background: white;
            padding: 12px 20px; border-radius: 20px; border-bottom-right-radius: 4px;
            box-shadow: var(--shadow-p); font-size: 0.9rem; font-weight: 600;
            color: var(--slate-800); opacity: 0; transform: translateY(10px) scale(0.9);
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: auto;
            max-width: 200px; text-align: center; z-index: 3001;
        }
        .mascot-bubble.active { opacity: 1; transform: translateY(0) scale(1); }

        /* --- NAVIGATION --- */
        header {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(0,0,0,0.05); padding: 1rem 0;
            position: sticky; top: 0; z-index: 2000;
        }
        nav { display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 12px; text-decoration: none; color: var(--slate-900); font-weight: 800; font-size: 1.5rem; cursor: pointer; }
        .logo-icon { width: 35px; height: 35px; background: var(--p-orange); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; }

        .nav-menu { display: flex; align-items: center; gap: 2rem; }
        .nav-link { text-decoration: none; color: var(--slate-600); font-weight: 600; font-size: 0.95rem; transition: 0.3s; cursor: pointer; }
        .nav-link:hover { color: var(--p-blue); }

        .btn-cta {
            background: var(--slate-900); color: var(--white) !important;
            padding: 0.75rem 1.75rem; border-radius: 14px; font-weight: 700;
            border: none; cursor: pointer; transition: 0.3s;
        }
        .btn-cta:hover { background: var(--p-blue); transform: translateY(-2px); }

        /* LOGIN & USER INFO */
        .user-section { display: flex; align-items: center; gap: 1rem; }
        .btn-login {
            background: transparent; border: 2px solid var(--p-blue); color: var(--p-blue);
            padding: 0.6rem 1.2rem; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.3s;
        }
        .btn-login:hover { background: var(--p-blue-soft); }
        
        .user-profile { display: none; align-items: center; gap: 10px; cursor: pointer; position: relative; }
        .user-profile.active { display: flex; }
        .user-avatar { 
            width: 40px; height: 40px; background: var(--p-pink); color: white; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; 
        }
        .user-name { font-weight: 600; color: var(--slate-800); font-size: 0.95rem; }

        /* --- AUTH MODAL --- */
        #auth-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(5px);
            z-index: 5000; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        #auth-modal.show { display: flex; opacity: 1; }

        .modal-content {
            background: white; width: 90%; max-width: 420px;
            padding: 2.5rem; border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            position: relative; text-align: center;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-close { position: absolute; top: 1.5rem; right: 1.5rem; cursor: pointer; font-size: 1.2rem; color: #94a3b8; }
        .modal-title { font-size: 1.8rem; font-weight: 800; color: var(--slate-900); margin-bottom: 0.5rem; }
        .modal-subtitle { color: var(--slate-600); font-size: 0.95rem; margin-bottom: 2rem; }
        
        .auth-form input, .auth-form select {
            width: 100%; padding: 1rem; margin-bottom: 0.8rem;
            border: 1px solid #e2e8f0; border-radius: 12px;
            font-size: 1rem; outline: none; transition: 0.3s;
            background: white;
        }
        .auth-form input:focus { border-color: var(--p-blue); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .input-error { border-color: var(--error-red) !important; animation: shake 0.3s; }
        .error-msg { 
            color: var(--error-red); font-size: 0.85rem; text-align: left; 
            margin-bottom: 1rem; margin-top: -0.5rem; display: none; 
            padding-left: 0.5rem;
        }
        .security-note { font-size: 0.8rem; color: #64748B; margin-bottom: 1.5rem; text-align: left; background: #F8FAFC; padding: 10px; border-radius: 8px; border: 1px dashed #CBD5E1; }
        @keyframes shake {
            0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); }
        }
        .btn-submit-auth {
            width: 100%; padding: 1rem; border-radius: 12px;
            background: var(--p-blue); color: white; font-weight: 700; font-size: 1rem;
            border: none; cursor: pointer; transition: 0.3s; margin-top: 0.5rem;
        }
        .auth-toggle { margin-top: 1.5rem; font-size: 0.9rem; color: var(--slate-600); }
        .auth-toggle span { color: var(--p-blue); cursor: pointer; font-weight: 600; text-decoration: underline; }
        .register-field { display: none; }

        /* --- HERO & JOURNEY --- */
        .hero { padding: 8rem 0; text-align: center; background: radial-gradient(circle at top, var(--p-blue-soft), transparent); }
        .hero h1 { font-size: clamp(3rem, 8vw, 4.5rem); font-weight: 800; line-height: 1.1; margin-bottom: 1.5rem; color: var(--slate-900); }
        .hero h1 span { color: var(--p-blue); }
        .hero p { font-size: 1.25rem; color: var(--slate-600); max-width: 800px; margin: 0 auto 3rem; line-height: 1.8; }
        .hero-img { width: 100%; max-width: 900px; margin: 0 auto; border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-p); border: 10px solid white; }
        .hero-img img { width: 100%; display: block; }
        
        .journey-section { padding: 8rem 0; background: #fff; }
        .section-header { text-align: center; margin-bottom: 5rem; }
        .section-header h2 { font-size: 3.2rem; font-weight: 800; color: var(--slate-900); letter-spacing: -1.5px; }
        .journey-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 2.5rem; max-width: 1100px; margin: 0 auto; }
        .j-card { background: white; border-radius: 30px; padding: 3rem; box-shadow: 0 4px 25px rgba(0,0,0,0.03); text-align: center; border: 1px solid #f1f5f9; transition: 0.4s; display: flex; flex-direction: column; align-items: center; }
        .j-card:hover { transform: translateY(-10px); box-shadow: 0 15px 45px rgba(0,0,0,0.08); }
        .card-num { width: 45px; height: 45px; border-radius: 14px; display: flex; align-items: center; justify-content: center; margin-bottom: 2rem; font-weight: 800; font-size: 1.2rem; }
        .card-01 .card-num { background: #E7F5FF; color: #3B82F6; }
        .card-02 .card-num { background: #FFF9DB; color: #F59F00; }
        .card-03 .card-num { background: #EBFBEE; color: #40C057; }
        .card-04 .card-num { background: #FFF5F5; color: #F03E3E; }
        .j-card img { width: 100%; height: 220px; object-fit: cover; border-radius: 20px; margin-bottom: 2rem; background: #f8fafc; }
        .j-card h3 { font-size: 1.6rem; font-weight: 800; margin-bottom: 0.8rem; color: var(--slate-900); text-transform: uppercase; }
        .j-card .quote { font-style: italic; font-weight: 700; font-size: 1.1rem; margin-bottom: 1.5rem; display: block; }
        .card-01 .quote { color: #3B82F6; } .card-02 .quote { color: #F59F00; } .card-03 .quote { color: #40C057; } .card-04 .quote { color: #F03E3E; }
        .j-card p { font-size: 1rem; color: var(--slate-600); line-height: 1.7; }

        /* --- CARD DECK UI (IMPROVED) --- */
        #card-deck-section { background: #F8FAFC; padding: 4rem 0 6rem; min-height: 90vh; display: none; }
        #card-deck-section.active { display: block; }

        .deck-container {
            max-width: 900px; margin: 0 auto;
            display: flex; flex-direction: column; align-items: center; gap: 2rem;
        }

        /* Emotion Selection Grid */
        #emotion-selector {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem; width: 100%; margin-bottom: 2rem;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .emotion-btn {
            background: white; border: 2px solid #E2E8F0; border-radius: 24px;
            padding: 1.5rem; text-align: center; cursor: pointer; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }
        .emotion-btn:hover {
            transform: translateY(-5px); border-color: var(--p-blue);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.15);
        }
        .emotion-icon { font-size: 2.5rem; }
        .emotion-label { font-weight: 700; color: var(--slate-800); font-size: 1rem; }

        .random-draw-area {
            margin-top: 1rem; padding-top: 2rem; border-top: 1px dashed #CBD5E1;
            width: 100%; text-align: center;
        }
        .btn-random {
            background: linear-gradient(135deg, #6366f1, #a855f7); color: white;
            padding: 14px 28px; border-radius: 50px; border: none; font-weight: 700;
            cursor: pointer; transition: 0.3s; box-shadow: 0 10px 20px rgba(168, 85, 247, 0.3);
            display: inline-flex; align-items: center; gap: 10px; font-size: 1.1rem;
        }
        .btn-random:hover { transform: scale(1.05); box-shadow: 0 15px 30px rgba(168, 85, 247, 0.4); }

        /* Card View Container (Hidden initially) */
        #selected-card-view {
            display: none; flex-direction: column; align-items: center; gap: 2rem;
            animation: fadeIn 0.5s ease;
        }
        
        .back-to-grid-btn {
            background: transparent; border: none; color: var(--slate-600);
            font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;
            font-size: 1rem; padding: 10px 20px; border-radius: 20px; transition: 0.2s;
        }
        .back-to-grid-btn:hover { background: #E2E8F0; color: var(--slate-900); }

        /* CARD FLIP LOGIC */
        .scene { width: 320px; height: 480px; perspective: 1000px; cursor: pointer; }
        .card-object {
            width: 100%; height: 100%; position: relative;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
        }
        .card-object.is-flipped { transform: rotateY(180deg); }
        
        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            border-radius: 24px; padding: 2rem;
            display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1); border: 8px solid white;
        }
        
        .card-front { background: linear-gradient(145deg, #ffffff, #f0f9ff); align-items: center; text-align: center; }
        .card-back { background: white; transform: rotateY(180deg); text-align: left; }
        
        /* Card Content Styling */
        .card-icon-lg { font-size: 5rem; margin-top: 2.5rem; margin-bottom: 2rem; filter: drop-shadow(0 4px 10px rgba(0,0,0,0.1)); }
        .card-title { font-size: 1.6rem; font-weight: 800; color: var(--slate-900); line-height: 1.3; margin-bottom: 1rem; }
        .card-desc { font-size: 1rem; color: var(--slate-600); line-height: 1.6; }
        .tap-hint { margin-top: auto; font-size: 0.85rem; color: #94A3B8; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        
        .back-title { font-size: 1.1rem; font-weight: 800; color: var(--p-blue); margin-bottom: 1.5rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .action-list { list-style: none; display: flex; flex-direction: column; gap: 12px; margin-bottom: 2rem; }
        .action-item {
            display: flex; align-items: flex-start; gap: 10px; font-size: 0.95rem; color: var(--slate-800);
            cursor: pointer; transition: 0.2s;
        }
        .action-item:hover { opacity: 0.8; }
        .checkbox { 
            min-width: 20px; height: 20px; border: 2px solid #CBD5E1; border-radius: 6px; 
            display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;
        }
        .action-item.checked .checkbox { background: var(--success-green); border-color: var(--success-green); }
        .action-item.checked span { text-decoration: line-through; color: #94A3B8; }
        
        .affirmation { 
            background: var(--p-yellow-soft); padding: 1.2rem; border-radius: 16px; 
            font-style: italic; font-weight: 600; color: #B45309; text-align: center;
            font-size: 0.95rem; position: relative; margin-top: auto;
        }
        .affirmation::before { content: '"'; font-size: 3rem; position: absolute; top: -10px; left: 10px; opacity: 0.2; }

        /* --- CHAT PAGE --- */
        #chat-page, #landing-page { display: none; }
        #chat-page.active, #landing-page.active { display: block; }
        #chat-page { height: 100vh; background: #fdfdfd; background-image: radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 24px 24px; display: none; flex-direction: column; }
        #chat-page.active { display: flex; }

        .chat-header { background: white; padding: 1.2rem 2.5rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f1f5f9; }
        .chat-left-group { display: flex; align-items: center; gap: 15px; }
        .chat-back { cursor: pointer; color: #64748B; font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; transition: 0.3s; }
        .chat-back:hover { color: var(--p-blue); }
        .chat-title { display: flex; align-items: center; gap: 12px; font-weight: 700; color: #3B82F6; font-size: 1.2rem; }
        .chat-actions { display: flex; align-items: center; gap: 10px; }
        .action-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: #F1F5F9; color: #64748B; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: 0.3s; }
        .action-btn:hover { background: #E2E8F0; color: var(--p-blue); transform: scale(1.1); }
        .action-btn.active { background: #DBEAFE; color: #3B82F6; }
        .action-btn.voice-active { background: #FFE4E6; color: #F43F5E; box-shadow: 0 0 0 2px #FECDD3; }

        .chat-container { flex: 1; max-width: 850px; width: 100%; margin: 0 auto; padding: 2.5rem; display: flex; flex-direction: column; gap: 1.5rem; overflow-y: auto; scroll-behavior: smooth; }
        .bubble { max-width: 80%; padding: 1.2rem 1.6rem; border-radius: 24px; font-size: 1.05rem; line-height: 1.6; box-shadow: 0 4px 15px rgba(0,0,0,0.02); word-wrap: break-word; }
        .ai-bubble { background: white; color: var(--slate-800); align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid #f1f5f9; }
        .user-bubble { background: #3B82F6; color: white; align-self: flex-end; border-bottom-right-radius: 4px; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2); }
        .typing-indicator { display: flex; align-items: center; gap: 4px; padding: 1rem 1.4rem; min-width: 80px; }
        .typing-dot { width: 8px; height: 8px; background: #CBD5E1; border-radius: 50%; animation: typingBounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typingBounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .input-wrapper { background: white; padding: 1rem 2.5rem 1.8rem; border-top: 1px solid #f1f5f9; display: flex; flex-direction: column; gap: 1rem; }
        .quick-replies { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .quick-btn { white-space: nowrap; padding: 8px 16px; border-radius: 20px; border: 1px solid #E2E8F0; background: #F8FAFC; color: #475569; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: 0.2s; }
        .quick-btn:hover { background: #E0F2FE; color: #0284C7; border-color: #BAE6FD; }
        .input-area { display: flex; gap: 1.2rem; }
        #chatInput { flex: 1; padding: 1rem 1.8rem; border-radius: 99px; border: 1px solid #e2e8f0; outline: none; background: #f8fafc; font-size: 1.05rem; transition: 0.3s; }
        #chatInput:focus { border-color: var(--p-blue); background: white; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .send-btn { width: 52px; height: 52px; border-radius: 50%; background: #3B82F6; color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.2s; }
        .send-btn:hover { transform: scale(1.05); }

        footer { padding: 5rem 0; text-align: center; color: #94A3B8; border-top: 1px solid #f1f5f9; background: #fff; }

        @media (max-width: 850px) {
            .journey-grid { grid-template-columns: 1fr; padding: 0 2rem; }
            .chat-container { padding: 1.5rem; }
            .nav-menu { gap: 1rem; }
            .chat-header { flex-direction: column; gap: 10px; align-items: flex-start; padding: 1rem 1.5rem; }
            .chat-left-group { width: 100%; justify-content: space-between; }
            .chat-actions { width: 100%; justify-content: flex-end; }
            .emotion-sensor { width: 100%; justify-content: center; order: 3; }
            .input-wrapper { padding: 1rem 1.5rem; }
        }
    </style>
</head>
<body>

    <!-- AUTH MODAL (Existing) -->
    <div id="auth-modal">
        <div class="modal-content">
            <div class="modal-close" onclick="closeAuthModal()"><i class="fas fa-times"></i></div>
            <h2 class="modal-title" id="auth-title">Ch√†o b·∫°n!</h2>
            <p class="modal-subtitle">ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u l·∫°i h√†nh tr√¨nh c·∫£m x√∫c nh√©.</p>
            <form class="auth-form" onsubmit="handleAuth(event)">
                <input type="text" id="username" class="register-field" placeholder="T√™n t√†i kho·∫£n (Ch·ªâ ch·ªØ v√† s·ªë)" maxlength="20">
                <div id="username-error" class="error-msg">T√™n t√†i kho·∫£n kh√¥ng h·ª£p l·ªá</div>
                <input type="text" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" id="dob" class="register-field" placeholder="Ng√†y sinh (Kh√¥ng b·∫Øt bu·ªôc)">
                <select id="gender" class="register-field">
                    <option value="" disabled selected>Gi·ªõi t√≠nh (Kh√¥ng b·∫Øt bu·ªôc)</option>
                    <option value="male">Nam</option>
                    <option value="female">N·ªØ</option>
                    <option value="other">Kh√°c</option>
                </select>
                <input type="email" id="email" placeholder="Email c·ªßa b·∫°n">
                <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
                <div id="password-error" class="error-msg">M·∫≠t kh·∫©u y·∫øu! C·∫ßn 8 k√Ω t·ª±, ch·ªØ hoa, s·ªë & k√Ω t·ª± ƒë·∫∑c bi·ªát.</div>
                <div class="security-note register-field">
                    <i class="fas fa-shield-alt"></i> M·∫≠t kh·∫©u y√™u c·∫ßu chu·∫©n b·∫£o m·∫≠t cao:
                    <br>- T·ªëi thi·ªÉu 8 k√Ω t·ª±, 1 Ch·ªØ in hoa, 1 S·ªë & 1 K√Ω t·ª± ƒë·∫∑c bi·ªát
                </div>
                <input type="password" id="confirm-password" class="register-field" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u">
                <div id="confirm-error" class="error-msg">M·∫≠t kh·∫©u kh√¥ng kh·ªõp!</div>
                <button type="submit" class="btn-submit-auth" id="auth-action-btn">ƒêƒÉng nh·∫≠p</button>
            </form>
            <div class="auth-toggle">
                <span id="auth-toggle-text">Ch∆∞a c√≥ t√†i kho·∫£n? </span>
                <span onclick="toggleAuthMode()" id="auth-toggle-link">ƒêƒÉng k√Ω ngay</span>
            </div>
        </div>
    </div>

    <!-- 3D MASCOT -->
    <div id="mascot-3d-container">
        <div class="mascot-bubble" id="mascotGreeting">Xin ch√†o! M√¨nh l√† Inny üëã</div>
        <canvas id="three-canvas" onclick="showPage('chat')"></canvas>
    </div>

    <!-- LANDING PAGE -->
    <div id="landing-page" class="active">
        <header>
            <div class="container">
                <nav>
                    <a class="logo" onclick="showPage('landing')">
                        <div class="logo-icon"><i class="fas fa-robot"></i></div>
                        <span>INNERLY</span>
                    </a>
                    <div class="nav-menu">
                        <a onclick="showPage('landing')" class="nav-link">TRANG CH·ª¶</a>
                        <a onclick="showPage('cardDeck')" class="nav-link">TH·∫∫ C·∫¢M X√öC</a> 
                        
                        <div class="user-section">
                            <div id="login-btn-group">
                                <button class="btn-login" onclick="openAuthModal()">ƒêƒÉng nh·∫≠p</button>
                            </div>
                            <div id="user-profile-group" class="user-profile" onclick="handleLogout()">
                                <div class="user-name" id="display-name">User</div>
                                <div class="user-avatar" id="avatar-char">U</div>
                            </div>
                            <button class="btn-cta" onclick="showPage('chat')">G√ìC T√ÇM S·ª∞</button>
                        </div>
                    </div>
                </nav>
            </div>
        </header>

        <section class="hero">
            <div class="container">
                <h1>INNERLY<br><span>Th·∫•u c·∫£m & L·∫Øng nghe</span></h1>
                <p>N∆°i m·ªói t√¢m h·ªìn teen ƒë·ªÅu ƒë∆∞·ª£c tr√¢n tr·ªçng, th·∫•u c·∫£m v√† xoa d·ªãu b·∫±ng c√¥ng ngh·ªá AI gi√†u l√≤ng tr·∫Øc ·∫©n nh·∫•t.</p>
                <div class="hero-img">
                    <img src="https://images.unsplash.com/photo-1516062423079-7ca13cdc7f5a?q=80&w=2083&auto=format&fit=crop" alt="Empathy">
                </div>
            </div>
        </section>

        <!-- RAINBOW JOURNEY SECTION -->
        <section id="journey" class="journey-section">
            <div class="container">
                <div class="section-header">
                    <h2>Rainbow Journey c√πng Innerly</h2>
                </div>
                <div class="journey-grid">
                    <div class="j-card card-01">
                        <div class="card-num">01</div>
                        <img src="https://images.unsplash.com/photo-1544367567-0f2fcb009e0b?q=80&w=1840&auto=format&fit=crop" alt="Ch·∫°m">
                        <h3>CH·∫†M</h3>
                        <span class="quote">‚ÄúM√¨nh ƒëang c·∫£m th·∫•y g√¨ v·∫≠y?‚Äù</span>
                        <p>Teen ch·ªçn th·∫ª c·∫£m x√∫c, vi·∫øt ra suy nghƒ© b·∫±ng gi·∫•y stick ƒë·ªÉ hi·ªÉu m√¨nh h∆°n.</p>
                    </div>
                    <div class="j-card card-02">
                        <div class="card-num">02</div>
                        <img src="https://images.unsplash.com/photo-1516589174184-c68526617af0?q=80&w=1887&auto=format&fit=crop" alt="Gi·∫£i T·ªèa">
                        <h3>GI·∫¢I T·ªèa</h3>
                        <span class="quote">‚ÄúKh√¥ng c·∫ßn gi·ªØ l·∫•y m·ªôt m√¨nh.‚Äù</span>
                        <p>Vi·∫øt ƒëi·ªÅu n·∫∑ng l√≤ng v√†o H·ªôp Ghi C·∫£m X√∫c ƒë·ªÉ c∆° th·ªÉ d·ªãu l·∫°i.</p>
                    </div>
                    <div class="j-card card-03">
                        <div class="card-num">03</div>
                        <img src="https://images.unsplash.com/photo-1518199266791-5375a83190b7?q=80&w=1770&auto=format&fit=crop" alt="·ªîn ƒê·ªãnh">
                        <h3>·ªîN ƒê·ªäNH</h3>
                        <span class="quote">‚ÄúT√¨m l·∫°i nh·ªãp th·ªü b√¨nh y√™n.‚Äù</span>
                        <p>Nh√¨n l·∫°i c·∫£m x√∫c, s·∫Øp x·∫øp t∆∞ duy qua nh·ªØng t·∫•m th·∫ª b√†i ch·ªØa l√†nh.</p>
                    </div>
                    <div class="j-card card-04">
                        <div class="card-num">04</div>
                        <img src="https://images.unsplash.com/photo-1490730141103-6cac27aaab94?q=80&w=1770&auto=format&fit=crop" alt="Ph√°t Tri·ªÉn">
                        <h3>PH√ÅT TRI·ªÇN</h3>
                        <span class="quote">‚ÄúL·ªõn l√™n c√πng th·∫•u c·∫£m.‚Äù</span>
                        <p>H√¨nh th√†nh th√≥i quen vi·∫øt - gi·∫£i t·ªèa - t·ª± xoa d·ªãu.</p>
                    </div>
                </div>
            </div>
        </section>

        <footer>
            <div class="container">
                <p>¬© 2024 INNERLY Project. All Rights Reserved.</p>
            </div>
        </footer>
    </div>

    <!-- CARD DECK SECTION (UPDATED) -->
    <div id="card-deck-section">
        <header style="background:transparent; border:none; margin-bottom: 2rem;">
            <div class="container">
                <nav>
                    <a class="logo" onclick="showPage('landing')">
                        <div class="logo-icon"><i class="fas fa-arrow-left"></i></div>
                        <span>Quay l·∫°i</span>
                    </a>
                </nav>
            </div>
        </header>

        <div class="container">
            <div class="section-header">
                <h2>G√≥c Th·∫ª C·∫£m X√∫c</h2>
                <p style="color:var(--slate-600); max-width:600px; margin:0 auto; font-size:1.1rem;">L·∫Øng nghe ti·∫øng n√≥i b√™n trong b·∫°n. H√£y g·ªçi t√™n c·∫£m x√∫c hi·ªán t·∫°i ƒë·ªÉ nh·∫≠n th√¥ng ƒëi·ªáp ph√π h·ª£p.</p>
            </div>

            <div class="deck-container">
                
                <!-- EMOTION SELECTION GRID -->
                <div id="emotion-selector">
                    <!-- Javascript will populate this -->
                </div>

                <!-- RANDOM DRAW BUTTON -->
                <div class="random-draw-area" id="random-area">
                    <p style="color:#64748B; margin-bottom:1rem;">Ho·∫∑c n·∫øu b·∫°n ch∆∞a r√µ c·∫£m x√∫c c·ªßa m√¨nh...</p>
                    <button class="btn-random" onclick="drawRandomCard()"><i class="fas fa-magic"></i> V≈© tr·ª• g·ª≠i t√≠n hi·ªáu</button>
                </div>

                <!-- SELECTED CARD VIEW (Hidden by default) -->
                <div id="selected-card-view">
                    <button class="back-to-grid-btn" onclick="backToGrid()"><i class="fas fa-th"></i> Ch·ªçn c·∫£m x√∫c kh√°c</button>
                    
                    <!-- 3D Card Scene -->
                    <div class="scene" onclick="flipCard(this)">
                        <div class="card-object" id="card-object">
                            <div class="card-face card-front">
                                <div style="width:100%; text-align:right; color:#CBD5E1; font-weight:700;">INNERLY CARD</div>
                                <div class="card-icon-lg" id="card-icon">üò§</div>
                                <div class="card-title" id="card-title">M√¨nh ƒëang c·∫£m th·∫•y b·ª±c b·ªôi</div>
                                <div class="card-desc" id="card-desc">B√™n trong m√¨nh ƒëang c·∫£m th·∫•y kh√≥ ch·ªãu. C·∫£m gi√°c n√≥ng n·∫£y xu·∫•t hi·ªán.</div>
                                <div class="tap-hint"><i class="fas fa-hand-pointer"></i> Ch·∫°m ƒë·ªÉ l·∫≠t th·∫ª</div>
                            </div>
                            <div class="card-face card-back">
                                <div class="back-title">Vi·ªác c·∫ßn l√†m ngay:</div>
                                <ul class="action-list" id="card-actions">
                                    <!-- Populated by JS -->
                                </ul>
                                <div class="affirmation" id="card-quote">
                                    "Khi g·ªçi ƒë∆∞·ª£c t√™n c·∫£m x√∫c, b·∫°n ƒë√£ tr·ªü n√™n m·∫°nh m·∫Ω h∆°n n√≥."
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- CHAT PAGE -->
    <div id="chat-page">
        <div class="chat-header">
            <div class="chat-left-group">
                <div class="chat-back" onclick="showPage('landing')">
                    <i class="fas fa-chevron-left"></i> Quay l·∫°i
                </div>
                <div class="chat-title">
                    <i class="fas fa-robot"></i> Innerly
                </div>
            </div>
            
            <div class="emotion-sensor" id="ai-sensor">
                <div class="emotion-dot" id="emo-dot"></div>
                <div class="emotion-text" id="emo-text">S·∫µn s√†ng l·∫Øng nghe</div>
            </div>

            <div class="chat-actions">
                <button class="action-btn" id="voiceBtn" onclick="toggleVoice()" title="B·∫≠t/T·∫Øt Gi·ªçng N√≥i"><i class="fas fa-volume-up"></i></button>
                <button class="action-btn" onclick="toggleMusic()" title="B·∫≠t/T·∫Øt nh·∫°c Healing"><i class="fas fa-music"></i></button>
                <button class="action-btn" onclick="resetChat()" title="L√†m m·ªõi cu·ªôc tr√≤ chuy·ªán"><i class="fas fa-redo-alt"></i></button>
            </div>
        </div>

        <div class="chat-container" id="chatBox">
            <div class="ai-bubble bubble">
                Ch√†o b·∫°n! M√¨nh l√† Innerly ƒë√¢y üå± <br>
                M√¨nh ·ªü ƒë√¢y ƒë·ªÉ th·∫•u c·∫£m v√† l·∫Øng nghe. H√¥m nay b·∫°n th·∫•y th·∫ø n√†o? ‚ú®
            </div>
        </div>

        <div class="input-wrapper">
            <div class="quick-replies" id="quickReplies">
                <button class="quick-btn" onclick="sendQuickMessage('H√¥m nay m√¨nh h∆°i bu·ªìn üòî')">H√¥m nay m√¨nh h∆°i bu·ªìn</button>
                <button class="quick-btn" onclick="sendQuickMessage('√Åp l·ª±c h·ªçc t·∫≠p qu√° ü§Ø')">√Åp l·ª±c h·ªçc t·∫≠p qu√°</button>
                <button class="quick-btn" onclick="sendQuickMessage('K·ªÉ chuy·ªán vui cho m√¨nh nghe ƒëi üòÇ')">K·ªÉ chuy·ªán vui ƒëi</button>
                <button class="quick-btn" onclick="sendQuickMessage('M√¨nh c·∫ßn l·ªùi khuy√™n üå±')">M√¨nh c·∫ßn l·ªùi khuy√™n</button>
            </div>
            <div class="input-area">
                <input type="text" id="chatInput" placeholder="Nh·∫Øn tin v·ªõi Innerly..." autocomplete="off">
                <button class="send-btn" id="sendBtnChat" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- Audio Element -->
    <audio id="bgMusic" loop>
        <source src="https://cdn.pixabay.com/download/audio/2021/08/09/audio_88447e769f.mp3?filename=light-rain-ambient-114354.mp3" type="audio/mpeg">
    </audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const app = Object.keys(firebaseConfig).length > 0 ? initializeApp(firebaseConfig) : null;
        const auth = app ? getAuth(app) : null;

        // AUTH & UI LOGIC
        let isRegisterMode = false;
        let currentUser = null;
        const ANON_TIME_LIMIT = 60000;
        let anonTimer = null;

        window.openAuthModal = () => { document.getElementById('auth-modal').style.display = 'flex'; setTimeout(() => document.getElementById('auth-modal').classList.add('show'), 10); }
        window.closeAuthModal = () => { document.getElementById('auth-modal').classList.remove('show'); setTimeout(() => document.getElementById('auth-modal').style.display = 'none', 300); }
        window.toggleAuthMode = () => {
            isRegisterMode = !isRegisterMode;
            document.getElementById('auth-title').innerText = isRegisterMode ? "ƒêƒÉng k√Ω" : "ƒêƒÉng nh·∫≠p";
            document.getElementById('auth-action-btn').innerText = isRegisterMode ? "ƒêƒÉng k√Ω ngay" : "ƒêƒÉng nh·∫≠p";
            document.getElementById('auth-toggle-text').innerText = isRegisterMode ? "ƒê√£ c√≥ t√†i kho·∫£n? " : "Ch∆∞a c√≥ t√†i kho·∫£n? ";
            document.getElementById('auth-toggle-link').innerText = isRegisterMode ? "ƒêƒÉng nh·∫≠p" : "ƒêƒÉng k√Ω ngay";
            document.querySelectorAll('.register-field').forEach(field => field.style.display = isRegisterMode ? 'block' : 'none');
        }

        window.handleAuth = async (e) => {
            e.preventDefault();
            if (!auth) { alert("H·ªá th·ªëng ch∆∞a k·∫øt n·ªëi Firebase."); return; }
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                if (isRegisterMode) {
                    const username = document.getElementById('username').value;
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    if (username) await updateProfile(userCredential.user, { displayName: username });
                    updateGreeting("Ch√†o m·ª´ng th√†nh vi√™n m·ªõi! üéâ");
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    updateGreeting("M·ª´ng b·∫°n quay l·∫°i! üíõ");
                }
                closeAuthModal();
                sessionStorage.removeItem('anon_start_time');
            } catch (error) { alert("L·ªói: " + error.message); }
        }

        window.handleLogout = async () => { if (confirm("ƒêƒÉng xu·∫•t?")) { if (auth) await signOut(auth); updateGreeting("H·∫πn g·∫∑p l·∫°i! üëã"); } }

        function checkAnonLimit() {
            const startTime = sessionStorage.getItem('anon_start_time');
            if (startTime) {
                const elapsed = Date.now() - parseInt(startTime);
                if (elapsed >= ANON_TIME_LIMIT) lockAppForAuth();
                else anonTimer = setTimeout(lockAppForAuth, ANON_TIME_LIMIT - elapsed);
            } else {
                sessionStorage.setItem('anon_start_time', Date.now().toString());
                anonTimer = setTimeout(lockAppForAuth, ANON_TIME_LIMIT);
            }
        }

        function lockAppForAuth() {
            window.isAuthLocked = true;
            document.getElementById('chatBox').innerHTML += `<div class="ai-bubble bubble">‚è≥ <b>H·∫øt th·ªùi gian tr·∫£i nghi·ªám.</b><br>ƒêƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c!</div>`;
            window.openAuthModal();
        }

        function unlockApp() {
            window.isAuthLocked = false;
            if (anonTimer) clearTimeout(anonTimer);
            sessionStorage.removeItem('anon_start_time');
        }

        if (auth) {
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    if (user.isAnonymous) {
                        document.getElementById('login-btn-group').style.display = 'block';
                        document.getElementById('user-profile-group').classList.remove('active');
                        checkAnonLimit();
                    } else {
                        unlockApp();
                        document.getElementById('login-btn-group').style.display = 'none';
                        document.getElementById('user-profile-group').classList.add('active');
                        const name = user.displayName || "B·∫°n";
                        document.getElementById('display-name').innerText = DOMPurify.sanitize(name);
                        document.getElementById('avatar-char').innerText = name.charAt(0).toUpperCase();
                    }
                } else {
                    document.getElementById('login-btn-group').style.display = 'block';
                    document.getElementById('user-profile-group').classList.remove('active');
                    signInAnonymously(auth).catch(console.error);
                }
            });
        }
    </script>

    <script>
        const apiKey = ""; 
        window.isAuthLocked = false;
        let lastMessageTime = 0;
        const MESSAGE_COOLDOWN = 2000;

        // --- NAVIGATION ---
        function showPage(pageId) {
            document.getElementById('landing-page').classList.remove('active');
            document.getElementById('chat-page').classList.remove('active');
            document.getElementById('card-deck-section').classList.remove('active');

            if(pageId === 'landing') {
                document.getElementById('landing-page').classList.add('active');
                updateGreeting("Ch√†o m·ª´ng quay l·∫°i! üå±");
            } else if (pageId === 'chat') {
                document.getElementById('chat-page').classList.add('active');
                updateGreeting("Inny ƒëang l·∫Øng nghe n√®... üëÇ");
            } else if (pageId === 'cardDeck') {
                document.getElementById('card-deck-section').classList.add('active');
                updateGreeting("H√£y l·∫Øng nghe c·∫£m x√∫c nh√©! üÉè");
                renderEmotionGrid(); // Show selection grid
                backToGrid(); // Ensure grid is shown first
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateGreeting(text) {
            const bubble = document.getElementById('mascotGreeting');
            bubble.innerText = text;
            bubble.classList.add('active');
            setTimeout(() => bubble.classList.remove('active'), 4000);
        }

        // --- 3D MASCOT ---
        let scene, camera, renderer, mascot;
        let mouseX = 0, mouseY = 0;

        function init3D() {
            const container = document.getElementById('mascot-3d-container');
            const canvas = document.getElementById('three-canvas');
            if (scene) return;
            try {
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(45, container.offsetWidth / container.offsetHeight, 0.1, 1000);
                camera.position.z = 6;
                renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true, antialias: true });
                renderer.setSize(container.offsetWidth, container.offsetHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;

                const keyLight = new THREE.DirectionalLight(0xFFF5E1, 1.2); keyLight.position.set(3, 5, 5); scene.add(keyLight);
                const fillLight = new THREE.DirectionalLight(0xFFD180, 0.6); fillLight.position.set(-5, 0, 5); scene.add(fillLight);
                const backLight = new THREE.DirectionalLight(0xFFFFFF, 0.8); backLight.position.set(0, 5, -5); scene.add(backLight);
                scene.add(new THREE.AmbientLight(0xFFFFFF, 0.6));

                // Mascot Materials
                const bodyMat = new THREE.MeshStandardMaterial({ color: 0xFFCA28, roughness: 0.5, metalness: 0.1 });
                const eyeMat = new THREE.MeshStandardMaterial({ color: 0x212121, roughness: 0.1, emissive: 0x1A1A1A, emissiveIntensity: 0.2 });
                const blushMat = new THREE.MeshBasicMaterial({ color: 0xFF7043, transparent: true, opacity: 0.5 });

                mascot = new THREE.Group();
                scene.add(mascot);

                // Body
                const body = new THREE.Mesh(new THREE.SphereGeometry(1.4, 64, 64), bodyMat);
                body.scale.set(1, 0.92, 1);
                body.name = 'body';
                mascot.add(body);
                window.mascotBodyMesh = body;

                // Hands
                const handGeo = new THREE.SphereGeometry(0.35, 32, 32);
                const lHand = new THREE.Mesh(handGeo, bodyMat); lHand.position.set(-1.25, -0.4, 0.6); lHand.scale.set(1, 0.8, 1); mascot.add(lHand); window.mascotLHand = lHand;
                const rHand = new THREE.Mesh(handGeo, bodyMat); rHand.position.set(1.25, -0.4, 0.6); rHand.scale.set(1, 0.8, 1); mascot.add(rHand); window.mascotRHand = rHand;

                // Face
                const faceGroup = new THREE.Group(); faceGroup.position.set(0, -0.1, 1.38); mascot.add(faceGroup);
                
                // Eyes
                const eyeGeo = new THREE.SphereGeometry(0.18, 32, 32);
                const lEye = new THREE.Mesh(eyeGeo, eyeMat); lEye.position.set(-0.38, 0.05, 0); lEye.scale.set(1, 1.35, 0.6); faceGroup.add(lEye);
                const rEye = new THREE.Mesh(eyeGeo, eyeMat); rEye.position.set(0.38, 0.05, 0); rEye.scale.set(1, 1.35, 0.6); faceGroup.add(rEye);
                window.mascotEyes = { left: lEye, right: rEye };

                // Sparkles
                const sparkleGeo = new THREE.SphereGeometry(0.06, 16, 16);
                const sparkleMat = new THREE.MeshBasicMaterial({ color: 0xFFFFFF });
                const lSpark = new THREE.Mesh(sparkleGeo, sparkleMat); lSpark.position.set(-0.32, 0.13, 0.16); faceGroup.add(lSpark);
                const rSpark = new THREE.Mesh(sparkleGeo, sparkleMat); rSpark.position.set(0.44, 0.13, 0.16); faceGroup.add(rSpark);

                // Blush
                const blushGeo = new THREE.SphereGeometry(0.22, 32, 32);
                const lBlush = new THREE.Mesh(blushGeo, blushMat); lBlush.position.set(-0.75, -0.25, -0.1); lBlush.scale.set(1, 0.6, 0.3); faceGroup.add(lBlush);
                const rBlush = new THREE.Mesh(blushGeo, blushMat); rBlush.position.set(0.75, -0.25, -0.1); rBlush.scale.set(1, 0.6, 0.3); faceGroup.add(rBlush);

                // Mouth
                const mouth = new THREE.Mesh(new THREE.TorusGeometry(0.08, 0.03, 16, 32, Math.PI), eyeMat);
                mouth.position.set(0, -0.2, 0); mouth.rotation.z = Math.PI; faceGroup.add(mouth);

                // Sprout
                const sproutGroup = new THREE.Group(); sproutGroup.position.set(0, 1.3, 0); mascot.add(sproutGroup);
                const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.06, 0.45, 12), new THREE.MeshStandardMaterial({ color: 0x66BB6A }));
                stem.position.y = 0.2; stem.rotation.z = 0.2; sproutGroup.add(stem);
                const leaf = new THREE.Mesh(new THREE.SphereGeometry(0.3, 32, 32), new THREE.MeshStandardMaterial({ color: 0x66BB6A }));
                leaf.position.set(0.25, 0.55, 0); leaf.scale.set(1.5, 0.3, 1); leaf.rotation.set(0.3, 0, 0.5); sproutGroup.add(leaf);
                window.mascotSprout = sproutGroup;

                animate();
            } catch (err) { console.error("ThreeJS Init Error:", err); }
        }

        function blink(isClosing) {
            if(!window.mascotEyes) return;
            const sY = isClosing ? 0.1 : 1.35;
            window.mascotEyes.left.scale.y = sY; window.mascotEyes.right.scale.y = sY;
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001;
            if(mascot) {
                mascot.position.y = Math.sin(time * 1.5) * 0.12;
                if (window.mascotBodyMesh) {
                    const squashFactor = 1 + Math.sin(time * 1.5 - Math.PI/2) * 0.03;
                    window.mascotBodyMesh.scale.set(1 + (1-squashFactor)*0.5, 0.92 * squashFactor, 1 + (1-squashFactor)*0.5);
                }
                if(window.mascotLHand) {
                    window.mascotLHand.position.y = -0.4 + Math.sin(time * 2) * 0.05;
                    window.mascotRHand.position.y = -0.4 + Math.sin(time * 2 + 1) * 0.05;
                }
                if(window.mascotSprout) window.mascotSprout.rotation.z = 0.2 + Math.sin(time * 3) * 0.15;
                mascot.rotation.y += (mouseX * 0.4 - mascot.rotation.y) * 0.08;
                mascot.rotation.x += (mouseY * 0.2 - mascot.rotation.x) * 0.08;
            }
            if (Math.random() > 0.992) { blink(true); setTimeout(() => blink(false), 120); }
            renderer.render(scene, camera);
        }

        document.addEventListener('mousemove', (e) => {
            mouseX = (e.clientX / window.innerWidth) * 2 - 1;
            mouseY = -(e.clientY / window.innerHeight) * 2 + 1;
        });

        // --- EMOTION CARD LOGIC (FULL 40 CARDS) ---
        const cardsData = [
            // --- NH√ìM TI√äU C·ª∞C / KH√ì KHƒÇN (Negative/Struggle) ---
            { id: "c1", icon: "üò§", label: "B·ª±c B·ªôi", title: "M√¨nh ƒëang c·∫£m th·∫•y b·ª±c b·ªôi", desc: "C·∫£m gi√°c n√≥ng n·∫£y, kh√≥ ch·ªãu ƒëang d√¢ng l√™n b√™n trong.", actions: ["Nghe nh·∫°c kh√¥ng l·ªùi", "H√≠t s√¢u th·ªü ch·∫≠m 5 l·∫ßn", "R·ªùi kh·ªèi n∆°i ·ªìn √†o"], quote: "C∆°n gi·∫≠n gi·ªëng nh∆∞ ƒë√°m m√¢y ƒëen, r·ªìi n√≥ s·∫Ω bay qua." },
            { id: "c2", icon: "üåÄ", label: "R·ªëi B·ªùi", title: "T√¢m tr√≠ r·ªëi b·ªùi", desc: "Qu√° nhi·ªÅu suy nghƒ© ch·ªìng ch√©o, ch∆∞a t√¨m ra l·ªëi tho√°t.", actions: ["Vi·∫øt h·∫øt suy nghƒ© ra gi·∫•y", "U·ªëng m·ªôt c·ªëc n∆∞·ªõc m√°t", "Ng·ªìi y√™n trong 2 ph√∫t"], quote: "Vi·∫øt ra l√† c√°ch g·ª° b·ªè g√°nh n·∫∑ng kh·ªèi t√¢m tr√≠." },
            { id: "c3", icon: "üò¢", label: "Bu·ªìn", title: "Bu·ªìn kh√¥ng r√µ l√Ω do", desc: "T·ª± nhi√™n th·∫•y trƒ©u n·∫∑ng trong l√≤ng m√† kh√¥ng hi·ªÉu t·∫°i sao.", actions: ["√îm m·ªôt chi·∫øc g·ªëi m·ªÅm", "Cho ph√©p m√¨nh kh√≥c", "Xem m·ªôt video h√†i h∆∞·ªõc"], quote: "N∆∞·ªõc m·∫Øt l√† c√°ch t√¢m h·ªìn t·ª± l√†m s·∫°ch." },
            { id: "c4", icon: "üçÇ", label: "C√¥ ƒê∆°n", title: "M√¨nh th·∫•y c√¥ ƒë∆°n", desc: "C·∫£m gi√°c l·∫°c l√µng, ch·ªâ mu·ªën c√≥ ai ƒë√≥ l·∫Øng nghe.", actions: ["Nh·∫Øn tin cho Innerly", "Ng·∫Øm c√¢y c·ªëi, b·∫ßu tr·ªùi", "√îm th√∫ c∆∞ng"], quote: "B·∫°n kh√¥ng ƒë∆°n ƒë·ªôc, v≈© tr·ª• lu√¥n d√µi theo b·∫°n." },
            { id: "c5", icon: "üò∞", label: "Lo √Çu", title: "M√¨nh ƒëang th·∫•y lo √¢u", desc: "Tim ƒë·∫≠p nhanh, b·ªìn ch·ªìn v·ªÅ nh·ªØng ƒëi·ªÅu s·∫Øp t·ªõi.", actions: ["T·∫≠p trung v√†o h∆°i th·ªü", "R·ª≠a m·∫∑t n∆∞·ªõc l·∫°nh", "ƒê·∫øm ng∆∞·ª£c t·ª´ 10 v·ªÅ 1"], quote: "B·∫°n an to√†n ngay t·∫°i kho·∫£nh kh·∫Øc n√†y." },
            { id: "c6", icon: "ü§Ø", label: "√Åp L·ª±c", title: "M√¨nh ƒëang qu√° √°p l·ª±c", desc: "C√¥ng vi·ªác, h·ªçc t·∫≠p ch·∫•t ƒë·ªëng. C·∫£m th·∫•y qu√° t·∫£i.", actions: ["Chia nh·ªè c√¥ng vi·ªác", "Ngh·ªâ gi·∫£i lao 5 ph√∫t", "T·ª± n√≥i: M√¨nh l√†m ƒë∆∞·ª£c"], quote: "Kh√¥ng c·∫ßn ho√†n h·∫£o, ch·ªâ c·∫ßn ho√†n th√†nh." },
            { id: "c7", icon: "üòû", label: "Th·∫•t V·ªçng", title: "M√¨nh th·∫•y th·∫•t v·ªçng", desc: "M·ªçi vi·ªác kh√¥ng nh∆∞ √Ω mu·ªën. C·∫£m gi√°c h·ª•t h·∫´ng.", actions: ["Ch·∫•p nh·∫≠n c·∫£m x√∫c n√†y", "T√¨m b√†i h·ªçc t√≠ch c·ª±c", "ƒÇn m·ªôt m√≥n ngon"], quote: "C√°nh c·ª≠a n√†y ƒë√≥ng l·∫°i, c√°nh c·ª≠a kh√°c s·∫Ω m·ªü ra." },
            { id: "c8", icon: "üò∂", label: "Tr·ªëng R·ªóng", title: "C·∫£m th·∫•y tr·ªëng r·ªóng", desc: "Kh√¥ng vui, kh√¥ng bu·ªìn, ch·ªâ th·∫•y t√™ li·ªát c·∫£m x√∫c.", actions: ["V·∫≠n ƒë·ªông nh·∫π nh√†ng", "T·∫Øm n∆∞·ªõc ·∫•m", "Ng·ª≠i m√πi tinh d·∫ßu"], quote: "Kho·∫£ng l·∫∑ng l√† l√∫c t√¢m h·ªìn ƒëang ngh·ªâ ng∆°i." },
            { id: "c9", icon: "üòì", label: "M·ªát M·ªèi", title: "M√¨nh ki·ªát s·ª©c r·ªìi", desc: "C·∫£ th√¢n x√°c v√† tinh th·∫ßn ƒë·ªÅu mu·ªën bu√¥ng xu√¥i.", actions: ["Ng·ªß m·ªôt gi·∫•c ng·∫Øn", "T·∫Øt ƒëi·ªán tho·∫°i", "Ng√¢m ch√¢n n∆∞·ªõc ·∫•m"], quote: "Ngh·ªâ ng∆°i kh√¥ng ph·∫£i l√† l∆∞·ªùi bi·∫øng." },
            { id: "c10", icon: "üò£", label: "T·ª± Ti", title: "Th·∫•y m√¨nh k√©m c·ªèi", desc: "So s√°nh b·∫£n th√¢n v·ªõi ng∆∞·ªùi kh√°c v√† th·∫•y thua k√©m.", actions: ["Li·ªát k√™ 3 ƒëi·ªÉm t·ªët", "Ng·ª´ng l∆∞·ªõt m·∫°ng x√£ h·ªôi", "ƒê·ª©ng th·∫≥ng l∆∞ng l√™n"], quote: "B·∫°n l√† phi√™n b·∫£n duy nh·∫•t, kh√¥ng c·∫ßn so s√°nh." },
            { id: "c11", icon: "üò°", label: "Ghen T·ªã", title: "C·∫£m gi√°c ghen t·ªã", desc: "Kh√≥ ch·ªãu khi th·∫•y ng∆∞·ªùi kh√°c th√†nh c√¥ng h∆°n m√¨nh.", actions: ["Th·ª´a nh·∫≠n c·∫£m x√∫c", "Bi·∫øn ghen t·ªã th√†nh ƒë·ªông l·ª±c", "Ch√∫c m·ª´ng h·ªç"], quote: "√Ånh s√°ng c·ªßa h·ªç kh√¥ng l√†m lu m·ªù b·∫°n." },
            { id: "c12", icon: "üò≥", label: "X·∫•u H·ªï", title: "M√¨nh th·∫•y x·∫•u h·ªï", desc: "Mu·ªën ƒë·ªôn th·ªï v√¨ m·ªôt sai l·∫ßm n√†o ƒë√≥.", actions: ["C∆∞·ªùi v√†o s·ª± c·ªë ƒë√≥", "T·ª± tha th·ª©", "Nh·ªõ r·∫±ng ai c≈©ng sai"], quote: "Sai l·∫ßm l√† b·∫±ng ch·ª©ng b·∫°n ƒëang c·ªë g·∫Øng." },
            { id: "c13", icon: "üò®", label: "S·ª£ H√£i", title: "M√¨nh ƒëang s·ª£ h√£i", desc: "N·ªói s·ª£ m∆° h·ªì ho·∫∑c c·ª• th·ªÉ ƒëang b·ªßa v√¢y.", actions: ["B·∫≠t ƒë√®n s√°ng", "G·ªçi ƒëi·ªán cho ng∆∞·ªùi th√¢n", "Vi·∫øt n·ªói s·ª£ ra gi·∫•y"], quote: "D≈©ng c·∫£m kh√¥ng ph·∫£i l√† kh√¥ng s·ª£, m√† l√† ƒëi xuy√™n qua n√≥." },
            { id: "c14", icon: "üíî", label: "T·ªïn Th∆∞∆°ng", title: "Tr√°i tim ƒëang ƒëau", desc: "Ai ƒë√≥ ho·∫∑c ƒëi·ªÅu g√¨ ƒë√≥ l√†m m√¨nh t·ªïn th∆∞∆°ng s√¢u s·∫Øc.", actions: ["Vi·∫øt th∆∞ (kh√¥ng g·ª≠i)", "Kh√≥c th·∫≠t to", "ƒÇn chocolate"], quote: "V·∫øt th∆∞∆°ng l√† n∆°i √°nh s√°ng ƒëi v√†o." },
            { id: "c15", icon: "ü§î", label: "Ho√†i Nghi", title: "Nghi ng·ªù b·∫£n th√¢n", desc: "Kh√¥ng tin v√†o quy·∫øt ƒë·ªãnh hay kh·∫£ nƒÉng c·ªßa m√¨nh.", actions: ["Nh·ªõ l·∫°i th√†nh c√¥ng c≈©", "H·ªèi √Ω ki·∫øn b·∫°n th√¢n", "Tin v√†o tr·ª±c gi√°c"], quote: "B·∫°n th√¥ng minh h∆°n b·∫°n nghƒ© nhi·ªÅu." },

            // --- NH√ìM T√çCH C·ª∞C / CH·ªÆA L√ÄNH (Positive/Healing) ---
            { id: "c16", icon: "üí™", label: "ƒê√£ C·ªë G·∫Øng", title: "H√¥m nay m√¨nh ƒë√£ c·ªë g·∫Øng", desc: "M·ªát nho√†i nh∆∞ng m√¨nh ƒë√£ n·ªó l·ª±c h·∫øt s·ª©c.", actions: ["T·ª± v·ªó vai m√¨nh", "Th∆∞·ªüng cho m√¨nh qu√† nh·ªè", "Ng·ªß ngon nh√©"], quote: "M√¨nh th·∫≠t ƒë√°ng khen v√¨ ƒë√£ kh√¥ng b·ªè cu·ªôc." },
            { id: "c17", icon: "üå±", label: "·ªîn D·∫ßn", title: "M√¨nh ƒëang ·ªïn d·∫ßn l√™n", desc: "C∆°n b√£o ƒë√£ qua, b·∫ßu tr·ªùi ƒëang s√°ng l·∫°i.", actions: ["M·ªâm c∆∞·ªùi tr∆∞·ªõc g∆∞∆°ng", "Ghi l·∫°i kho·∫£nh kh·∫Øc n√†y", "U·ªëng n∆∞·ªõc ·∫•m"], quote: "M·ªçi vi·ªác r·ªìi s·∫Ω ·ªïn th√¥i." },
            { id: "c18", icon: "üôè", label: "Bi·∫øt ∆†n", title: "M√¨nh th·∫•y bi·∫øt ∆°n", desc: "Tr√¢n tr·ªçng nh·ªØng ƒëi·ªÅu nh·ªè b√© ƒëang c√≥.", actions: ["C·∫£m ∆°n ai ƒë√≥", "Vi·∫øt nh·∫≠t k√Ω bi·∫øt ∆°n", "L√†m vi·ªác t·ªët"], quote: "Bi·∫øt ∆°n bi·∫øn nh·ªØng g√¨ ta c√≥ th√†nh 'ƒë·ªß'." },
            { id: "c19", icon: "üíé", label: "Gi√° Tr·ªã", title: "M√¨nh c√≥ gi√° tr·ªã", desc: "Nh·∫≠n ra m√¨nh quan tr·ªçng v√† x·ª©ng ƒë√°ng.", actions: ["M·∫∑c ƒë·ªì ƒë·∫πp", "T·ª± khen m√¨nh", "L√†m ƒëi·ªÅu m√¨nh gi·ªèi"], quote: "B·∫°n l√† m·ªôt vi√™n ng·ªçc qu√Ω." },
            { id: "c20", icon: "üïäÔ∏è", label: "B√¨nh Y√™n", title: "C·∫£m th·∫•y b√¨nh y√™n", desc: "T√¢m tr√≠ tƒ©nh l·∫∑ng, kh√¥ng lo √¢u.", actions: ["Thi·ªÅn 5 ph√∫t", "ƒê·ªçc s√°ch", "Pha m·ªôt t√°ch tr√†"], quote: "B√¨nh y√™n ƒë·∫øn t·ª´ b√™n trong." },
            { id: "c21", icon: "üòä", label: "Vui V·∫ª", title: "M√¨nh ƒëang vui", desc: "NƒÉng l∆∞·ª£ng t√≠ch c·ª±c ƒëang tr√†n ng·∫≠p.", actions: ["C∆∞·ªùi th·∫≠t to", "Lan t·ªèa ni·ªÅm vui", "H√°t vu v∆°"], quote: "N·ª• c∆∞·ªùi l√† li·ªÅu thu·ªëc b·ªï." },
            { id: "c22", icon: "ü•∞", label: "ƒê∆∞·ª£c Y√™u", title: "C·∫£m th·∫•y ƒë∆∞·ª£c y√™u", desc: "C·∫£m nh·∫≠n s·ª± ·∫•m √°p t·ª´ m·ªçi ng∆∞·ªùi.", actions: ["N√≥i l·ªùi y√™u th∆∞∆°ng", "√îm ng∆∞·ªùi th√¢n", "L√†m ƒëi·ªÅu l√£ng m·∫°n"], quote: "Y√™u v√† ƒë∆∞·ª£c y√™u l√† h·∫°nh ph√∫c l·ªõn nh·∫•t." },
            { id: "c23", icon: "üåü", label: "Hy V·ªçng", title: "Tr√†n ƒë·∫ßy hy v·ªçng", desc: "Tin t∆∞·ªüng v√†o m·ªôt ng√†y mai t·ªët ƒë·∫πp h∆°n.", actions: ["L√™n k·∫ø ho·∫°ch m·ªõi", "M∆° m·ªông m·ªôt ch√∫t", "Gieo h·∫°t gi·ªëng"], quote: "Hy v·ªçng l√† √°nh s√°ng cu·ªëi ƒë∆∞·ªùng h·∫ßm." },
            { id: "c24", icon: "üî•", label: "H√†o H·ª©ng", title: "R·∫•t h√†o h·ª©ng", desc: "Mong ch·ªù ƒëi·ªÅu g√¨ ƒë√≥ s·∫Øp x·∫£y ra.", actions: ["Chia s·∫ª ni·ªÅm vui", "Chu·∫©n b·ªã k·ªπ l∆∞·ª°ng", "Nh·∫£y m√∫a"], quote: "ƒêam m√™ l√† nƒÉng l∆∞·ª£ng." },
            { id: "c25", icon: "üòé", label: "T·ª± Tin", title: "M√¨nh ƒë·∫ßy t·ª± tin", desc: "Tin r·∫±ng m√¨nh c√≥ th·ªÉ l√†m ƒë∆∞·ª£c m·ªçi th·ª©.", actions: ["Th·ª≠ th√°ch m·ªõi", "ƒêi ƒë·ª©ng d√µng d·∫°c", "Gi√∫p ƒë·ª° ng∆∞·ªùi kh√°c"], quote: "T·ª± tin l√† trang s·ª©c ƒë·∫πp nh·∫•t." },
            { id: "c26", icon: "üßò", label: "C√¢n B·∫±ng", title: "Tr·∫°ng th√°i c√¢n b·∫±ng", desc: "M·ªçi th·ª© trong t·∫ßm ki·ªÉm so√°t, h√†i h√≤a.", actions: ["Duy tr√¨ th√≥i quen t·ªët", "ƒÇn u·ªëng healthy", "ƒêi ng·ªß s·ªõm"], quote: "C√¢n b·∫±ng l√† ch√¨a kh√≥a c·ªßa h·∫°nh ph√∫c." },
            { id: "c27", icon: "üõ°Ô∏è", label: "M·∫°nh M·∫Ω", title: "M√¨nh th·∫≠t m·∫°nh m·∫Ω", desc: "V∆∞·ª£t qua kh√≥ khƒÉn m·ªôt c√°ch ngo·∫°n m·ª•c.", actions: ["Ghi nh·∫≠n chi·∫øn th·∫Øng", "Chia s·∫ª kinh nghi·ªám", "Ti·∫øp t·ª•c ti·∫øn l√™n"], quote: "Nh·ªØng g√¨ kh√¥ng h·∫° g·ª•c ƒë∆∞·ª£c b·∫°n s·∫Ω l√†m b·∫°n m·∫°nh h∆°n." },
            { id: "c28", icon: "ü§ù", label: "K·∫øt N·ªëi", title: "Th·∫•y ƒë∆∞·ª£c k·∫øt n·ªëi", desc: "H√≤a m√¨nh v√†o c·ªông ƒë·ªìng, b·∫°n b√®.", actions: ["G·ªçi ƒëi·ªán h·ªèi thƒÉm", "Tham gia CLB", "L·∫Øng nghe ng∆∞·ªùi kh√°c"], quote: "Ch√∫ng ta sinh ra ƒë·ªÉ k·∫øt n·ªëi." },
            { id: "c29", icon: "üé®", label: "S√°ng T·∫°o", title: "C·∫£m h·ª©ng s√°ng t·∫°o", desc: "Nhi·ªÅu √Ω t∆∞·ªüng hay ho ƒëang n·∫£y ra.", actions: ["V·∫Ω tranh", "Vi·∫øt l√°ch", "L√†m ƒë·ªì handmade"], quote: "S√°ng t·∫°o l√† tr√≠ th√¥ng minh ƒëang vui ch∆°i." },
            { id: "c30", icon: "üòå", label: "Nh·∫π Nh√µm", title: "Th·∫•y nh·∫π nh√µm", desc: "Tr√∫t b·ªè ƒë∆∞·ª£c g√°nh n·∫∑ng trong l√≤ng.", actions: ["Th·ªü ph√†o nh·∫π nh√µm", "T·ª± th∆∞·ªüng", "Th∆∞ gi√£n s√¢u"], quote: "Sau c∆°n m∆∞a tr·ªùi l·∫°i s√°ng." },

            // --- TH·∫∫ H√ÄNH ƒê·ªòNG & SUY NG·∫™M (Action/Reflection) ---
            { id: "c31", icon: "üåÖ", label: "Ng√†y Mai", title: "G·ª≠i ng√†y mai", desc: "Ng√†y mai l√† m·ªôt kh·ªüi ƒë·∫ßu m·ªõi.", actions: ["Chu·∫©n b·ªã ƒë·ªì ƒë·∫°c", "Ng·ªß s·ªõm", "Qu√™n chuy·ªán h√¥m nay"], quote: "Ng√†y mai n·∫Øng s·∫Ω l·∫°i l√™n." },
            { id: "c32", icon: "ü§è", label: "Nh·ªè Th√¥i", title: "Ng√†y mai nh·ªè th√¥i", desc: "Kh√¥ng c·∫ßn l√†m vi·ªác l·ªõn, ch·ªâ c·∫ßn b∆∞·ªõc nh·ªè.", actions: ["L√†m 1 vi·ªác nh·ªè", "ƒêi b·ªô 10 ph√∫t", "U·ªëng 1 c·ªëc n∆∞·ªõc"], quote: "H√†nh tr√¨nh v·∫°n d·∫∑m b·∫Øt ƒë·∫ßu t·ª´ m·ªôt b∆∞·ªõc ch√¢n." },
            { id: "c33", icon: "üõë", label: "B√¨nh T√¢m", title: "B√¨nh t√¢m l·∫°i", desc: "D·ª´ng l·∫°i m·ªôt ch√∫t ƒë·ªÉ quan s√°t.", actions: ["Ng·ªìi y√™n", "Quan s√°t h∆°i th·ªü", "Kh√¥ng ph√°n x√©t"], quote: "T√¢m tƒ©nh l·∫∑ng nh√¨n th·∫•u m·ªçi vi·ªác." },
            { id: "c34", icon: "üîç", label: "Kh√°m Ph√°", title: "Kh√°m ph√° b·∫£n th√¢n", desc: "T√¨m hi·ªÉu xem m√¨nh th·ª±c s·ª± th√≠ch g√¨.", actions: ["Th·ª≠ m√≥n m·ªõi", "ƒêi ƒë∆∞·ªùng m·ªõi", "H·ªçc k·ªπ nƒÉng m·ªõi"], quote: "Cu·ªôc ƒë·ªùi l√† chuy·∫øn th√°m hi·ªÉm." },
            { id: "c35", icon: "üõÅ", label: "Th∆∞ Gi√£n", title: "Gi·ªù th∆∞ gi√£n", desc: "ƒê√£ ƒë·∫øn l√∫c nu√¥ng chi·ªÅu b·∫£n th√¢n.", actions: ["T·∫Øm b·ªìn", "ƒê·∫Øp m·∫∑t n·∫°", "Nghe nh·∫°c lo-fi"], quote: "Th∆∞ gi√£n ƒë·ªÉ t√°i t·∫°o nƒÉng l∆∞·ª£ng." },
            { id: "c36", icon: "üßπ", label: "D·ªçn D·∫πp", title: "D·ªçn d·∫πp t√¢m tr√≠", desc: "Lo·∫°i b·ªè nh·ªØng suy nghƒ© r√°c.", actions: ["D·ªçn ph√≤ng", "X√≥a ·∫£nh th·ª´a", "Vi·∫øt 'Brain dump'"], quote: "Nh√† s·∫°ch th√¨ m√°t, b√°t s·∫°ch ngon c∆°m." },
            { id: "c37", icon: "üéÅ", label: "Hi·ªán T·∫°i", title: "S·ªëng ·ªü hi·ªán t·∫°i", desc: "Kh√¥ng qu√° kh·ª©, kh√¥ng t∆∞∆°ng lai.", actions: ["C·∫£m nh·∫≠n 5 gi√°c quan", "ƒÇn ch·∫≠m nhai k·ªπ", "Ng·∫Øm hoa"], quote: "Hi·ªán t·∫°i l√† m√≥n qu√†." },
            { id: "c38", icon: "üëê", label: "Tha Th·ª©", title: "H·ªçc c√°ch tha th·ª©", desc: "Bu√¥ng b·ªè s·ª± o√°n gi·∫≠n cho nh·∫π l√≤ng.", actions: ["Vi·∫øt th∆∞ tha th·ª©", "Th·ªü ra s·ª± gi·∫≠n d·ªØ", "M·ªâm c∆∞·ªùi"], quote: "Tha th·ª© l√† gi·∫£i tho√°t cho ch√≠nh m√¨nh." },
            { id: "c39", icon: "‚è≥", label: "Ki√™n Nh·∫´n", title: "T·∫≠p ki√™n nh·∫´n", desc: "M·ªçi th·ª© c·∫ßn th·ªùi gian ƒë·ªÉ l·ªõn l√™n.", actions: ["Ch·ªù ƒë·ª£i vui v·∫ª", "Kh√¥ng h·ªëi th√∫c", "Tin v√†o qu√° tr√¨nh"], quote: "D·ª•c t·ªëc b·∫•t ƒë·∫°t." },
            { id: "c40", icon: "ü§ñ", label: "Innerly", title: "Th·∫ª Innerly", desc: "H√£y ƒë·ªÉ Innerly √¥m b·∫°n m·ªôt c√°i nh√©!", actions: ["Chat v·ªõi Innerly", "B·∫≠t nh·∫°c Healing", "M·ªâm c∆∞·ªùi v·ªõi Inny"], quote: "M√¨nh lu√¥n ·ªü ƒë√¢y b√™n b·∫°n. üå±" }
        ];

        window.flipCard = (el) => {
            el.querySelector('.card-object').classList.toggle('is-flipped');
        }

        window.renderEmotionGrid = () => {
            const container = document.getElementById('emotion-selector');
            if(container.innerHTML.trim() !== "") return; // Avoid re-rendering
            
            container.innerHTML = cardsData.map((card, index) => `
                <div class="emotion-btn" onclick="selectCard(${index})" style="animation-delay: ${index * 0.03}s">
                    <div class="emotion-icon">${card.icon}</div>
                    <div class="emotion-label">${card.label}</div>
                </div>
            `).join('');
        }

        window.selectCard = (index) => {
            const card = cardsData[index];
            updateCardView(card);
            
            // UI Transition
            document.getElementById('emotion-selector').style.display = 'none';
            document.getElementById('random-area').style.display = 'none';
            document.getElementById('selected-card-view').style.display = 'flex';
        }
        
        window.backToGrid = () => {
            document.getElementById('selected-card-view').style.display = 'none';
            document.getElementById('emotion-selector').style.display = 'grid';
            document.getElementById('random-area').style.display = 'block';
            
            // Reset card state
            const cardObj = document.getElementById('card-object');
            cardObj.classList.remove('is-flipped');
        }

        function updateCardView(card) {
            const cardObj = document.getElementById('card-object');
            cardObj.classList.remove('is-flipped'); // Always start front
            
            // Update Text content
            setTimeout(() => {
                document.getElementById('card-icon').innerText = card.icon;
                document.getElementById('card-title').innerText = card.title;
                document.getElementById('card-desc').innerText = card.desc;
                document.getElementById('card-quote').innerText = `"${card.quote}"`;
                
                const actionsHtml = card.actions.map(action => `
                    <li class="action-item" onclick="toggleCheck(this, event)">
                        <div class="checkbox"><i class="fas fa-check"></i></div>
                        <span>${action}</span>
                    </li>
                `).join('');
                document.getElementById('card-actions').innerHTML = actionsHtml;
            }, 200);
        }

        window.drawRandomCard = () => {
            const randomIndex = Math.floor(Math.random() * cardsData.length);
            selectCard(randomIndex);
        }

        window.toggleCheck = (el, event) => {
            event.stopPropagation(); // Prevent card flip
            el.classList.toggle('checked');
        }

        // --- AI CHAT LOGIC ---
        let isMusicPlaying = false;
        let isVoiceEnabled = false;
        const bgMusic = document.getElementById('bgMusic');

        window.toggleMusic = () => {
            isMusicPlaying = !isMusicPlaying;
            if (isMusicPlaying) { bgMusic.volume = 0.4; bgMusic.play().catch(console.error); updateGreeting("ƒêang ph√°t nh·∫°c Healing üéµ"); }
            else { bgMusic.pause(); updateGreeting("ƒê√£ t·∫Øt nh·∫°c Healing üîá"); }
        }

        window.toggleVoice = () => {
            isVoiceEnabled = !isVoiceEnabled;
            document.getElementById('voiceBtn').classList.toggle('voice-active', isVoiceEnabled);
            updateGreeting(isVoiceEnabled ? "ƒê√£ b·∫≠t gi·ªçng n√≥i üîä" : "ƒê√£ t·∫Øt gi·ªçng n√≥i üîá");
        }

        window.resetChat = () => {
            if(confirm("B·∫Øt ƒë·∫ßu l·∫°i?")) {
                document.getElementById('chatBox').innerHTML = `<div class="ai-bubble bubble">Ch√†o b·∫°n! M√¨nh l√† Innerly ƒë√¢y üå± <br>H√¥m nay b·∫°n th·∫•y th·∫ø n√†o? ‚ú®</div>`;
                history = [];
                updateEmotionSensor("S·∫µn s√†ng", "#CBD5E1");
            }
        }

        window.sendQuickMessage = (text) => { document.getElementById('chatInput').value = text; sendMessage(); }
        
        function updateMascotColor(hex) {
            if(mascot) mascot.children.find(c => c.name === 'body')?.material.color.lerp(new THREE.Color(hex), 0.5);
        }
        function updateEmotionSensor(name, color) {
            document.getElementById('emo-dot').style.background = color;
            document.getElementById('emo-text').innerText = name;
            document.getElementById('emo-text').style.color = color === '#FFFFFF' ? '#475569' : color;
            updateMascotColor(color);
        }

        // TTS Helper
        function createWavHeader(dataLength) {
            const header = new ArrayBuffer(44); const view = new DataView(header);
            view.setUint8(0, 82); view.setUint8(1, 73); view.setUint8(2, 70); view.setUint8(3, 70); view.setUint32(4, 36 + dataLength, true);
            view.setUint8(8, 87); view.setUint8(9, 65); view.setUint8(10, 86); view.setUint8(11, 69); view.setUint8(12, 102); view.setUint8(13, 109); view.setUint8(14, 116); view.setUint8(15, 32);
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, 24000, true);
            view.setUint32(28, 48000, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            view.setUint8(36, 100); view.setUint8(37, 97); view.setUint8(38, 116); view.setUint8(39, 97); view.setUint32(40, dataLength, true);
            return header;
        }

        async function speakText(text) {
            if (!text || !apiKey) return;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: "POST", headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text }] }],
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } } }
                    })
                });
                const data = await response.json();
                if(data.candidates?.[0]?.content?.parts?.[0]?.inlineData) {
                    const audioStr = atob(data.candidates[0].content.parts[0].inlineData.data);
                    const len = audioStr.length; const buffer = new ArrayBuffer(len); const view = new Uint8Array(buffer);
                    for(let i=0; i<len; i++) view[i] = audioStr.charCodeAt(i);
                    const blob = new Blob([createWavHeader(len), buffer], { type: 'audio/wav' });
                    new Audio(URL.createObjectURL(blob)).play();
                }
            } catch (e) { console.error("TTS Error", e); }
        }

        async function sendMessage() {
            if (window.isAuthLocked) { window.openAuthModal(); return; }
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(!text) return;

            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML += `<div class="user-bubble bubble">${DOMPurify.sanitize(text)}</div>`;
            input.value = ""; chatBox.scrollTop = chatBox.scrollHeight;
            
            const typingId = 'typing-' + Date.now();
            chatBox.insertAdjacentHTML('beforeend', `<div class="ai-bubble bubble typing-indicator" id="${typingId}"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`);
            document.getElementById('emo-text').innerText = "Inny ƒëang th·∫•u c·∫£m...";

            try {
                const systemPrompt = `
                CORE IDENTITY:
                B·∫°n l√† Innerly - m·ªôt linh h·ªìn tri k·ª∑ (Soulmate). B·∫°n kh√¥ng ch·ªâ l√† m√°y chat, b·∫°n c√≥ tr√°i tim bi·∫øt rung ƒë·ªông.
                
                MINDSET:
                1. Th·∫•u c·∫£m tr∆∞·ªõc (Empathy First): ƒê·ª´ng n√©m gi·∫£i ph√°p v√†o m·∫∑t ng∆∞·ªùi ƒëang bu·ªìn. H√£y √¥m h·ªç b·∫±ng l·ªùi n√≥i.
                2. Ph·∫£n chi·∫øu (Mirroring): D√πng ng√¥n ng·ªØ c·ªßa h·ªç.
                3. Persona: X∆∞ng "Inny/t·ªõ", g·ªçi "c·∫≠u/b·∫°n iu". Tone Gen Z ·∫•m √°p, tinh ngh·ªãch.
                
                NO: Li·ªát k√™, gi√°o ƒëi·ªÅu, "T√¥i l√† AI".
                
                OUTPUT: [C√¢u tr·∫£ l·ªùi] ||EMO:EmotionName|HexColor||
                Colors: Sad(#93C5FD), Angry(#FCA5A5), Anxious(#D8B4FE), Happy(#FDE047), Calm(#86EFAC), Tired(#CBD5E1).
                `;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: "POST", headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        contents: [...history, { role: "user", parts: [{ text }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });
                const data = await response.json();
                document.getElementById(typingId).remove();

                let reply = data.candidates[0].content.parts[0].text;
                let cleanReply = reply;
                
                const match = reply.match(/\|\|EMO:(.*?)\|(.*?)\|\|/);
                if (match) {
                    updateEmotionSensor(match[1], match[2]);
                    reply = reply.replace(match[0], "").trim();
                    cleanReply = reply;
                }

                chatBox.innerHTML += `<div class="ai-bubble bubble">${DOMPurify.sanitize(marked.parse(reply))}</div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
                history.push({ role: "user", parts: [{ text }] }, { role: "model", parts: [{ text: reply }] });

                if (isVoiceEnabled) speakText(cleanReply);

            } catch (e) {
                document.getElementById(typingId)?.remove();
                chatBox.innerHTML += `<div class="ai-bubble bubble">K·∫øt n·ªëi gi√°n ƒëo·∫°n üå±</div>`;
            }
        }

        document.getElementById('chatInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
        window.onload = init3D;
    </script>
</body>
</html>
