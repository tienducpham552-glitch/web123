<!DOCTYPE html>
<!-- 
    PROJECT: INNERLY (ULTIMATE TET EDITION)
    DESCRIPTION: Phi√™n b·∫£n T·∫øt cao c·∫•p v·ªõi hi·ªáu ·ª©ng hoa r∆°i, l·ªìng ƒë√®n v√† S·ªï X·ªë L√¨ X√¨.
    VERSION: 3.5.0 (Tet Lottery Update)
    
    >>> CHANGES <<<
    1. MENU: Th√™m n√∫t "üßß H√°i L·ªôc" l√™n thanh menu ch√≠nh.
    2. LOTTERY UI: N√¢ng c·∫•p giao di·ªán nh·∫≠p m√£ th√†nh "Bao L√¨ X√¨" v·ªõi hi·ªáu ·ª©ng r∆°i ti·ªÅn v√†ng.
    3. VISUALS: T·ªëi ∆∞u hi·ªáu ·ª©ng hoa r∆°i v√† l·ªìng ƒë√®n.
-->
<html lang="vi">

<head>
    <!-- ==========================================================================
         META TAGS & SECURITY CONFIGURATION
         ========================================================================== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>INNERLY | L·ªôc Xu√¢n B√¨nh An</title>
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    
    <!-- CSP: Gi·ªØ nguy√™n l·ªõp b·∫£o v·ªá -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://www.gstatic.com https://threejs.org; 
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; 
        font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; 
        img-src 'self' data: https://images.unsplash.com; 
        connect-src 'self' https://generativelanguage.googleapis.com https://www.google-analytics.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firestore.googleapis.com; 
        media-src 'self' https://cdn.pixabay.com;
        frame-ancestors 'none';
    ">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XEELZR1L2D"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-XEELZR1L2D');
    </script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons & Libs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- DOMPurify & ThreeJS -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- ==========================================================================
         STYLES (CSS)
         ========================================================================== -->
    <style>
        :root {
            /* --- ORIGINAL COLOR PALETTE --- */
            --p-blue: #3B82F6;
            --p-blue-soft: #DBEAFE; 
            --p-pink: #F472B6;
            --p-pink-soft: #FCE7F3;
            --p-green: #34D399;
            --p-green-soft: #D1FAE5;
            --p-orange: #FB923C;
            --p-yellow: #FACC15;
            --slate-900: #1E293B;
            --slate-700: #475569;
            --slate-500: #94A3B8;
            --white: #ffffff;
            --off-white: #F8FAFC;
            --border-color: #F1F5F9;
            
            /* --- TET EVENT COLORS --- */
            --tet-red: #D20F22;
            --tet-gold: #FFD700;
            --tet-bg: #FFF5F5;
            
            --shadow-sm: 0 2px 8px rgba(148, 163, 184, 0.15);
            --shadow-md: 0 8px 24px rgba(148, 163, 184, 0.15);
            --shadow-card: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
            
            --radius-lg: 32px;
            --radius-md: 20px;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* * GLOBAL RESET * */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; font-size: 16px; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(180deg, #F0F9FF 0%, #FDF4FF 100%);
            background-attachment: fixed;
            color: var(--slate-700);
            line-height: 1.7;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* * TYPOGRAPHY * */
        h1, h2, h3, .logo span { font-family: 'Plus Jakarta Sans', sans-serif; color: var(--slate-900); }
        h1 { font-weight: 800; letter-spacing: -0.03em; }
        h2 { font-weight: 700; letter-spacing: -0.02em; }
        p { font-weight: 400; color: var(--slate-700); }

        .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; }

        /* * 3D MASCOT * */
        #mascot-3d-container {
            position: fixed; bottom: 30px; right: 30px;
            width: 280px; height: 320px; z-index: 9999;
            pointer-events: none; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @media (max-width: 1024px) { #mascot-3d-container { width: 220px; height: 260px; } }
        @media (max-width: 600px) { #mascot-3d-container { width: 140px; height: 180px; bottom: 20px; right: 10px; } }

        #three-canvas {
            width: 100%; height: 100%; pointer-events: auto; cursor: pointer;
            transition: transform 0.3s ease;
            filter: drop-shadow(0 15px 35px rgba(59, 130, 246, 0.2));
        }
        #three-canvas:active { transform: scale(0.9); }

        .mascot-bubble {
            position: absolute; top: 0; right: 15%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            padding: 10px 18px; border-radius: 20px; border-bottom-right-radius: 4px;
            box-shadow: var(--shadow-md); font-size: 0.9rem; font-weight: 600;
            color: var(--p-blue); border: 1px solid rgba(255,255,255,0.8);
            opacity: 0; transform: translateY(15px) scale(0.9);
            transition: 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none; max-width: 180px; text-align: center;
        }
        .mascot-bubble.active { opacity: 1; transform: translateY(0) scale(1); }

        /* * HEADER * */
        header {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
            padding: 0.8rem 0;
            position: sticky; top: 0; z-index: 2000;
        }
        nav { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
        
        .logo { display: flex; align-items: center; gap: 12px; text-decoration: none; cursor: pointer; }
        .logo-icon { 
            width: 42px; height: 42px; 
            background: linear-gradient(135deg, var(--p-blue), #60A5FA); 
            border-radius: 14px; display: flex; align-items: center; justify-content: center; 
            color: white; font-size: 1.2rem; box-shadow: 0 8px 16px rgba(37, 99, 235, 0.2);
        }
        .logo span { font-size: 1.35rem; font-weight: 800; letter-spacing: -0.5px; }

        .nav-menu { display: flex; align-items: center; gap: 2rem; }
        .nav-link { 
            text-decoration: none; color: var(--slate-700); font-weight: 500; font-size: 0.95rem; 
            transition: 0.3s; position: relative; padding: 0.5rem 0; cursor: pointer;
        }
        .nav-link:hover { color: var(--p-blue); }
        .nav-link::after {
            content: ''; position: absolute; width: 0; height: 2px; bottom: 0; left: 0;
            background: var(--p-blue); transition: width 0.3s; border-radius: 2px;
        }
        .nav-link:hover::after { width: 100%; }

        /* SPECIAL TET LINK ON MENU */
        .tet-link {
            color: var(--tet-red) !important;
            font-weight: 800;
            display: flex; align-items: center; gap: 6px;
            background: rgba(255, 215, 0, 0.15);
            padding: 0.5rem 1rem !important;
            border-radius: 99px;
            border: 1px solid var(--tet-gold);
            animation: pulse-gold 2s infinite;
        }
        .tet-link:hover {
            background: var(--tet-red); color: var(--tet-gold) !important;
            box-shadow: 0 4px 12px rgba(210, 15, 34, 0.3);
        }
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        .btn-cta {
            background: linear-gradient(135deg, var(--slate-900), #334155);
            color: white !important; padding: 0.7rem 1.6rem; border-radius: 99px;
            border: none; cursor: pointer; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.15);
            font-weight: 700; letter-spacing: 0.5px;
        }
        .btn-cta:hover { 
            transform: translateY(-2px) scale(1.02); 
            box-shadow: 0 15px 25px rgba(37, 99, 235, 0.25);
            background: linear-gradient(135deg, var(--p-blue), #2563EB); 
        }

        @media (max-width: 900px) {
            .nav-menu { gap: 0.8rem; overflow-x: auto; padding: 0.5rem 0; scrollbar-width: none; justify-content: flex-start; width: 100%; }
            .nav-menu::-webkit-scrollbar { display: none; }
            .nav-link, .tet-link { font-size: 0.85rem; white-space: nowrap; padding: 0.5rem 0.8rem !important; background: rgba(255,255,255,0.6); border-radius: 12px; border: 1px solid rgba(0,0,0,0.05); }
            .btn-cta { padding: 0.5rem 1rem; font-size: 0.85rem; }
            header { padding: 0.5rem 0; }
            .container { padding: 0 1rem; }
        }

        .user-section { display: flex; align-items: center; gap: 0.8rem; }
        .btn-login {
            background: white; border: 1px solid var(--border-color); color: var(--slate-700);
            padding: 0.6rem 1.2rem; border-radius: 12px; cursor: pointer; transition: 0.3s;
            font-weight: 600; box-shadow: var(--shadow-sm);
        }
        .btn-login:hover { border-color: var(--p-blue); color: var(--p-blue); transform: translateY(-1px); }
        
        .user-profile { display: none; align-items: center; gap: 12px; cursor: pointer; padding: 4px 12px; border-radius: 99px; transition: 0.3s; }
        .user-profile:hover { background: rgba(255,255,255,0.8); }
        .user-profile.active { display: flex; }
        .user-avatar { 
            width: 40px; height: 40px; 
            background: linear-gradient(135deg, #F472B6, #C084FC); 
            color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 1rem; font-weight: 700; box-shadow: 0 4px 10px rgba(244, 114, 182, 0.3);
            border: 2px solid white;
        }

        /* * MODAL * */
        #auth-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(12px);
            z-index: 10001; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s; padding: 1rem;
        }
        #auth-modal.show { display: flex; opacity: 1; }
        .modal-content {
            background: white; width: 100%; max-width: 420px;
            padding: 3rem; border-radius: 32px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
            border: 1px solid white; position: relative; text-align: center;
        }
        .auth-form input, .auth-form select {
            width: 100%; padding: 1rem 1.2rem; margin-bottom: 1rem;
            border: 2px solid transparent; border-radius: 16px;
            font-size: 16px; outline: none; transition: 0.3s; 
            background: #F1F5F9; color: var(--slate-900);
        }
        .auth-form input:focus { 
            background: white; border-color: var(--p-blue); 
            box-shadow: 0 0 0 4px var(--p-blue-soft); 
        }
        .btn-submit-auth { 
            width: 100%; padding: 1rem; font-size: 1.05rem; border-radius: 16px; 
            background: linear-gradient(135deg, var(--p-blue), #2563EB); 
            color: white; border: none; font-weight: 700; cursor: pointer;
            margin-top: 1rem; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
            transition: 0.3s;
        }
        .btn-submit-auth:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(37, 99, 235, 0.3); }

        /* * HERO & JOURNEY * */
        #landing-page { display: none; }
        #landing-page.active { display: block; animation: fadeIn 0.6s ease-out; }

        .hero { padding: 5rem 0 6rem; text-align: center; }
        .hero h1 { 
            font-size: clamp(2.8rem, 6vw, 4.2rem); line-height: 1.1; margin-bottom: 1.5rem; 
            color: var(--slate-900); 
        }
        .hero h1 span { 
            background: linear-gradient(135deg, var(--p-blue), #EC4899); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
        }
        .hero p { 
            font-size: clamp(1.15rem, 2.5vw, 1.3rem); color: var(--slate-700); 
            max-width: 700px; margin: 0 auto 3.5rem; opacity: 0.9; 
        }
        .hero-img { 
            width: 100%; max-width: 900px; margin: 0 auto; 
            border-radius: 32px; overflow: hidden; 
            box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.1); 
            border: 8px solid rgba(255,255,255,0.5);
            transform: perspective(1000px) rotateX(1deg);
        }

        .journey-section { padding: 5rem 0; background: transparent; }
        .section-header h2 { font-size: clamp(2.2rem, 5vw, 3rem); margin-bottom: 1.2rem; text-align: center; }
        
        .journey-grid { 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 2.5rem; 
            max-width: 1100px; margin: 4rem auto 0; 
        }
        @media (max-width: 768px) { .journey-grid { grid-template-columns: 1fr; gap: 2rem; } }

        .j-card { 
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 32px; padding: 2.5rem; 
            border: 1px solid white; 
            text-align: center; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            height: 100%; display: flex; flex-direction: column; align-items: center;
            box-shadow: var(--shadow-card);
        }
        .j-card:hover { 
            transform: translateY(-10px); 
            box-shadow: 0 25px 50px -12px rgba(59, 130, 246, 0.15); 
            background: white;
        }
        
        .j-card img {
            width: 100%; height: 240px; object-fit: cover; 
            border-radius: 24px; margin-bottom: 1.8rem;
            box-shadow: var(--shadow-sm); transition: 0.3s;
        }
        .j-card:hover img { transform: scale(1.02); }

        .card-num { 
            width: 56px; height: 56px; border-radius: 20px; 
            display: flex; align-items: center; justify-content: center; 
            margin: 0 auto 1.5rem; font-weight: 800; font-size: 1.3rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .card-01 .card-num { background: var(--p-blue-soft); color: var(--p-blue); }
        .card-02 .card-num { background: #FFEDD5; color: var(--p-orange); }
        .card-03 .card-num { background: var(--p-green-soft); color: var(--p-green); }
        .card-04 .card-num { background: var(--p-pink-soft); color: var(--p-pink); }
        
        .j-card h3 { font-size: 1.4rem; margin-bottom: 0.8rem; font-weight: 800; letter-spacing: 0.5px; }
        .j-card p { font-size: 1rem; line-height: 1.8; color: var(--slate-700); margin-top: auto; }
        .j-card .quote { 
            font-size: 1.1rem; font-style: italic; margin-bottom: 1.2rem; font-weight: 500;
            display: block; min-height: 30px;
        }
        .card-01 .quote { color: var(--p-blue); } 
        .card-02 .quote { color: var(--p-orange); } 
        .card-03 .quote { color: var(--p-green); } 
        .card-04 .quote { color: var(--p-pink); }

        /* * CARD DECK PAGE * */
        #card-deck-section { background: transparent; padding: 2rem 0 6rem; min-height: 100vh; display: none; }
        #card-deck-section.active { display: block; animation: fadeIn 0.5s ease; }
        
        /* NEW: GENDER TOGGLE SWITCH */
        .gender-toggle-container {
            display: flex; justify-content: center; margin-bottom: 2rem;
        }
        .gender-switch {
            background: white; border-radius: 99px; padding: 6px;
            display: flex; gap: 4px; box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        .gender-btn {
            padding: 10px 24px; border-radius: 99px; border: none; font-weight: 700;
            font-size: 1rem; cursor: pointer; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--slate-500); background: transparent;
            min-width: 100px;
        }
        .gender-btn.active.male {
            background: var(--p-blue); color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .gender-btn.active.female {
            background: var(--p-pink); color: white;
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
        }
        .gender-btn:hover:not(.active) { background: #F8FAFC; color: var(--slate-700); }

        .deck-container { padding-top: 1rem; }
        
        #emotion-selector {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1.5rem;
        }

        .emotion-btn {
            background: white; border: 1px solid white; border-radius: 24px;
            padding: 1.8rem 1rem; text-align: center; cursor: pointer; transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; flex-direction: column; align-items: center; gap: 12px;
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.05);
        }
        .emotion-btn:hover { 
            border-color: var(--p-blue-soft); 
            transform: translateY(-5px) scale(1.05); 
            box-shadow: 0 20px 30px -10px rgba(59, 130, 246, 0.15); 
        }
        .emotion-icon { font-size: 2.8rem; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        .emotion-label { font-weight: 700; color: var(--slate-700); font-size: 1.1rem; }

        /* * 3D CARD * */
        .scene { width: 100%; max-width: 340px; aspect-ratio: 2/3; perspective: 1200px; cursor: pointer; margin: 2rem auto; }
        .card-object { width: 100%; height: 100%; position: relative; transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-style: preserve-3d; }
        .card-object.is-flipped { transform: rotateY(180deg); }
        
        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            border-radius: 32px; padding: 2.5rem;
            display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 30px 60px -12px rgba(0,0,0,0.15);
            background: white; border: 4px solid white;
        }
        .card-front { 
            background: linear-gradient(135deg, #ffffff 0%, #F0F9FF 100%); 
            align-items: center; text-align: center; 
        }
        .card-back { transform: rotateY(180deg); text-align: left; background: #FEFCE8; } 
        
        .card-icon-lg { font-size: 5.5rem; margin: 2rem 0; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1)); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .card-title { font-size: 1.6rem; font-weight: 800; color: var(--slate-900); line-height: 1.3; margin-bottom: 1rem; }
        .card-desc { font-size: 1.1rem; color: var(--slate-700); }
        
        .action-item { 
            padding: 12px; background: white; border-radius: 16px; margin-bottom: 8px;
            color: var(--slate-700); font-weight: 600; display: flex; align-items: flex-start; gap: 14px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); cursor: pointer; transition: 0.2s;
        }
        .action-item:hover { transform: translateX(5px); }
        .checkbox { 
            min-width: 24px; height: 24px; border: 2px solid #CBD5E1; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; transition: 0.2s;
        }
        .action-item.checked .checkbox { background: var(--p-green); border-color: var(--p-green); }
        .action-item.checked span { text-decoration: line-through; color: var(--slate-500); opacity: 0.7; }
        
        .back-to-grid-btn {
            background: white; border: none; padding: 12px 24px; border-radius: 99px;
            font-weight: 700; color: var(--slate-700); box-shadow: var(--shadow-sm); cursor: pointer;
            display: flex; align-items: center; gap: 8px; margin: 0 auto; transition: 0.3s;
        }
        .back-to-grid-btn:hover { background: var(--p-blue-soft); color: var(--p-blue); transform: translateY(-2px); }

        /* * CHAT PAGE * */
        #chat-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh; height: 100dvh;
            background: #F8FAFC; display: none; flex-direction: column; z-index: 5000;
        }
        #chat-page.active { display: flex; animation: fadeIn 0.4s ease-out; }

        .chat-header {
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px);
            padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid rgba(0,0,0,0.05); flex-shrink: 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.02);
        }
        .chat-back { cursor: pointer; font-weight: 600; color: var(--slate-700); display: flex; align-items: center; gap: 6px; }
        .chat-back:hover { color: var(--p-blue); }
        
        .chat-title { font-weight: 800; font-size: 1.2rem; color: var(--p-blue); display: flex; align-items: center; gap: 8px; }

        .emotion-sensor { 
            display: flex; align-items: center; gap: 8px; background: white; padding: 6px 12px; border-radius: 99px;
            box-shadow: var(--shadow-sm); font-size: 0.85rem; font-weight: 600;
        }
        .emotion-dot { width: 10px; height: 10px; border-radius: 50%; background: #CBD5E1; transition: 0.3s; }

        .chat-actions .action-btn {
            background: transparent; border: none; font-size: 1.1rem; color: var(--slate-500);
            cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s;
        }
        .chat-actions .action-btn:hover { background: var(--p-blue-soft); color: var(--p-blue); }
        .voice-active { color: var(--p-blue) !important; animation: pulse 1.5s infinite; }

        .chat-container {
            flex: 1; width: 100%; max-width: 900px; margin: 0 auto;
            padding: 2rem 1.5rem; display: flex; flex-direction: column; gap: 1.5rem;
            overflow-y: auto; scroll-behavior: smooth;
        }
        
        .bubble {
            max-width: 80%; padding: 1.2rem 1.6rem; border-radius: 24px;
            font-size: 1.05rem; line-height: 1.6; font-weight: 400;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); position: relative;
        }
        .ai-bubble {
            background: white; color: var(--slate-700);
            border-bottom-left-radius: 4px; border: 1px solid rgba(0,0,0,0.03);
        }
        .user-bubble {
            background: linear-gradient(135deg, var(--p-blue), #2563EB);
            color: white; align-self: flex-end;
            border-bottom-right-radius: 4px;
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }
        
        .input-wrapper {
            background: white; padding: 1.2rem 1.5rem calc(1.2rem + var(--safe-bottom));
            border-top: 1px solid rgba(0,0,0,0.05);
            display: flex; flex-direction: column; gap: 1rem; flex-shrink: 0;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.03);
        }
        
        .quick-replies { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .quick-replies::-webkit-scrollbar { display: none; }
        .quick-btn {
            padding: 10px 20px; border-radius: 99px; font-size: 0.9rem; font-weight: 600;
            border: 1px solid var(--border-color); background: #F8FAFC; color: var(--slate-700);
            transition: 0.2s; white-space: nowrap;
        }
        .quick-btn:hover { 
            border-color: var(--p-blue-soft); background: var(--p-blue-soft); color: var(--p-blue); 
            transform: translateY(-2px);
        }

        .input-area { display: flex; gap: 12px; align-items: center; }
        #chatInput {
            flex: 1; padding: 1rem 1.5rem; border-radius: 99px;
            border: 2px solid transparent; outline: none; background: #F1F5F9;
            font-size: 1rem; transition: 0.3s; height: 56px; color: var(--slate-900);
        }
        #chatInput:focus { 
            background: white; border-color: var(--p-blue-soft); 
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); 
        }
        
        .mic-btn, .send-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
            transition: 0.3s;
        }
        .mic-btn { background: #F1F5F9; color: var(--slate-500); }
        .mic-btn:hover { background: #E2E8F0; color: var(--slate-900); }
        .mic-btn.listening { background: #FEE2E2; color: #EF4444; animation: pulse 1s infinite; }
        
        .send-btn { 
            background: linear-gradient(135deg, var(--p-blue), #2563EB); 
            color: white; box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3); 
        }
        .send-btn:hover { transform: scale(1.1) rotate(-10deg); }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        footer { padding: 3rem 0; text-align: center; color: var(--slate-500); opacity: 0.8; font-size: 0.9rem; }

        /* ==========================================================================
           TET EVENT STYLES (ENHANCED)
           ========================================================================== */
        .tet-floating-btn {
            position: fixed; bottom: 120px; right: 30px;
            width: 70px; height: 70px;
            background: linear-gradient(135deg, var(--tet-red), #FF4500);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 9900;
            box-shadow: 0 10px 25px rgba(210, 15, 34, 0.4);
            border: 3px solid var(--tet-gold);
            animation: shake 2.5s infinite;
        }
        .tet-floating-btn i { font-size: 2rem; color: var(--tet-gold); }
        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            10%, 30%, 50% { transform: rotate(-10deg); scale(1.1); }
            20%, 40%, 60% { transform: rotate(10deg); scale(1.1); }
            70% { transform: rotate(0deg) scale(1); }
        }
        .tet-badge {
            position: absolute; top: -5px; right: -5px;
            background: var(--tet-gold); color: var(--tet-red);
            font-size: 0.7rem; font-weight: 800; padding: 2px 8px; border-radius: 99px;
            border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #tet-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            z-index: 10002; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s; padding: 1rem;
        }
        #tet-modal.show { display: flex; opacity: 1; }
        
        /* NEW RED ENVELOPE STYLE MODAL */
        .tet-modal-content {
            background: linear-gradient(135deg, #D20F22, #991B1B);
            width: 100%; max-width: 400px;
            padding: 3rem 2rem; border-radius: 40px;
            border: 4px solid var(--tet-gold); 
            text-align: center; position: relative; overflow: hidden;
            box-shadow: 0 0 80px rgba(255, 215, 0, 0.4);
            color: var(--tet-gold);
        }
        .tet-decor { position: absolute; font-size: 6rem; opacity: 0.15; color: var(--tet-gold); pointer-events: none; }
        .decor-1 { top: -20px; left: -20px; transform: rotate(-15deg); }
        .decor-2 { bottom: -20px; right: -20px; transform: rotate(15deg); }
        .decor-3 { top: 40%; left: 10%; font-size: 2rem; opacity: 0.3; animation: float 3s infinite; }
        .decor-4 { top: 20%; right: 10%; font-size: 3rem; opacity: 0.2; animation: float 4s infinite reverse; }

        .tet-title { color: var(--tet-gold); font-weight: 900; font-size: 2rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .tet-desc { color: #FECACA; margin-bottom: 2rem; font-size: 1rem; opacity: 0.9; }
        
        .tet-input-group { position: relative; margin-bottom: 1.5rem; }
        .tet-input { 
            width: 100%; padding: 1.2rem; border-radius: 99px;
            border: 3px solid var(--tet-gold); background: #FFF5F5; 
            font-size: 1.3rem; text-align: center; font-weight: 800; color: #B91C1C;
            outline: none; transition: 0.3s; letter-spacing: 3px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        .tet-input:focus { transform: scale(1.05); box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
        .tet-input::placeholder { color: #FCA5A5; font-weight: 600; font-size: 1rem; letter-spacing: 1px; }
        
        .tet-submit-btn {
            background: linear-gradient(180deg, #FCD34D, #F59E0B);
            color: #991B1B; border: none; padding: 1rem 2rem;
            border-radius: 99px; font-weight: 900; font-size: 1.2rem;
            cursor: pointer; width: 100%; box-shadow: 0 6px 0 #B45309, 0 15px 20px rgba(0,0,0,0.3);
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px;
            text-transform: uppercase;
        }
        .tet-submit-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 0 #B45309, 0 20px 30px rgba(0,0,0,0.3); filter: brightness(1.1); }
        .tet-submit-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #B45309; }

        .tet-result { display: none; margin-top: 1.5rem; padding: 1rem; border-radius: 16px; font-weight: 700; border: 2px dashed rgba(255,255,255,0.3); background: rgba(0,0,0,0.2); backdrop-filter: blur(5px); }
        .tet-result.success { color: #FEF08A; border-color: #FEF08A; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .tet-result.error { color: #FECACA; border-color: #FECACA; }
        
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- NEW TET EFFECTS --- */
        .falling-blossom {
            position: fixed; top: -20px; z-index: 9998;
            animation: fall linear forwards;
            pointer-events: none; opacity: 0.9;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        @keyframes fall {
            to { transform: translateY(105vh) rotate(360deg) translateX(20px); }
        }
        
        .falling-coin {
            position: fixed; top: -30px; z-index: 10003;
            width: 30px; height: 30px; background: url('https://cdn-icons-png.flaticon.com/512/2933/2933116.png') no-repeat center/contain;
            animation: fall-coin linear forwards; pointer-events: none;
        }
        @keyframes fall-coin { to { transform: translateY(110vh) rotate(720deg); } }
        
        .lantern-container {
            position: fixed; top: -10px; width: 100%; z-index: 9997; pointer-events: none;
            display: flex; justify-content: space-between; padding: 0 30px;
        }
        .lantern {
            font-size: 3.5rem; animation: swing 4s infinite ease-in-out; 
            transform-origin: top center; color: var(--tet-red);
            filter: drop-shadow(0 10px 15px rgba(255, 50, 50, 0.3));
        }
        .lantern:nth-child(2) { animation-delay: 1s; color: var(--tet-gold); font-size: 3rem; margin-top: 10px; }
        @keyframes swing { 
            0%, 100% { transform: rotate(-5deg); } 
            50% { transform: rotate(5deg); } 
        }

        @media (max-width: 600px) {
            .tet-floating-btn { width: 55px; height: 55px; bottom: 100px; right: 20px; }
            .tet-floating-btn i { font-size: 1.4rem; }
            .lantern { font-size: 2.5rem; }
            .tet-modal-content { padding: 2rem 1.5rem; }
        }
    </style>
</head>

<body>

    <!-- AUTH MODAL (Original) -->
    <div id="auth-modal">
        <div class="modal-content">
            <div class="modal-close" style="position:absolute; top:20px; right:20px; cursor:pointer; color:var(--slate-500);" onclick="closeAuthModal()">
                <i class="fas fa-times" style="font-size:1.2rem;"></i>
            </div>
            
            <h2 class="modal-title" id="auth-title" style="font-size:1.8rem; margin-bottom:0.5rem; font-weight:800;">Ch√†o b·∫°n!</h2>
            <p class="modal-subtitle" style="margin-bottom:2rem; color:var(--slate-500);">ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u l·∫°i h√†nh tr√¨nh c·∫£m x√∫c nh√©.</p>
            
            <form class="auth-form" onsubmit="handleAuth(event)">
                <input type="text" id="username" class="register-field" placeholder="T√™n t√†i kho·∫£n (Ch·ªâ ch·ªØ v√† s·ªë)" maxlength="20">
                <div id="username-error" class="error-msg" style="display:none; color:red; font-size:0.8rem;">T√™n t√†i kho·∫£n kh√¥ng h·ª£p l·ªá</div>
                
                <input type="text" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" id="dob" class="register-field" placeholder="Ng√†y sinh (Kh√¥ng b·∫Øt bu·ªôc)">
                
                <select id="gender" class="register-field">
                    <option value="" disabled selected>Gi·ªõi t√≠nh (Kh√¥ng b·∫Øt bu·ªôc)</option>
                    <option value="male">Nam</option>
                    <option value="female">N·ªØ</option>
                    <option value="other">Kh√°c</option>
                </select>
                
                <input type="email" id="email" placeholder="Email c·ªßa b·∫°n">
                <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
                
                <div id="password-error" class="error-msg" style="display:none; color:red; font-size:0.8rem;">M·∫≠t kh·∫©u y·∫øu! C·∫ßn 8 k√Ω t·ª±, ch·ªØ hoa, s·ªë & k√Ω t·ª± ƒë·∫∑c bi·ªát.</div>
                
                <div class="security-note register-field" style="text-align:left; font-size:0.85rem; color:var(--slate-500); margin-bottom:1rem; padding:10px; background:#F8FAFC; border-radius:12px;">
                    <i class="fas fa-shield-alt"></i> M·∫≠t kh·∫©u y√™u c·∫ßu chu·∫©n b·∫£o m·∫≠t cao:
                    <br>- T·ªëi thi·ªÉu 8 k√Ω t·ª±, 1 Ch·ªØ in hoa, 1 S·ªë & 1 K√Ω t·ª± ƒë·∫∑c bi·ªát
                </div>
                
                <input type="password" id="confirm-password" class="register-field" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u">
                <div id="confirm-error" class="error-msg" style="display:none; color:red; font-size:0.8rem;">M·∫≠t kh·∫©u kh√¥ng kh·ªõp!</div>
                
                <button type="submit" class="btn-submit-auth" id="auth-action-btn">ƒêƒÉng nh·∫≠p</button>
            </form>
            
            <div class="auth-toggle" style="margin-top:1.5rem; font-size:0.95rem;">
                <span id="auth-toggle-text">Ch∆∞a c√≥ t√†i kho·∫£n? </span>
                <span onclick="toggleAuthMode()" id="auth-toggle-link" style="color:var(--p-blue); font-weight:700; cursor:pointer;">ƒêƒÉng k√Ω ngay</span>
            </div>
        </div>
    </div>

    <!-- TET EVENT MODAL (NEW DESIGN) -->
    <div id="tet-modal">
        <div class="tet-modal-content">
            <div class="modal-close" style="position:absolute; top:20px; right:20px; cursor:pointer; color: #FCA5A5;" onclick="closeTetModal()">
                <i class="fas fa-times" style="font-size:1.5rem;"></i>
            </div>
            
            <!-- Decorations -->
            <i class="fas fa-fan tet-decor decor-1"></i>
            <i class="fas fa-star tet-decor decor-2"></i>
            <i class="fas fa-coins tet-decor decor-3"></i>
            <i class="fas fa-money-bill-wave tet-decor decor-4"></i>

            <div style="font-size: 4rem; margin-bottom: 0.5rem; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.2));">üßß</div>
            <h2 class="tet-title">V√íNG QUAY L√å X√å</h2>
            <p class="tet-desc">Nh·∫≠p m√£ b√≠ m·∫≠t t√¨m th·∫•y trong s·∫£n ph·∫©m Innerly ƒë·ªÉ nh·∫≠n l√¨ x√¨ may m·∫Øn ƒë·∫ßu nƒÉm!</p>

            <div class="tet-input-group">
                <input type="text" id="tet-code-input" class="tet-input" placeholder="NH·∫¨P M√É CODE" maxlength="15" onkeyup="this.value = this.value.toUpperCase();">
            </div>

            <button class="tet-submit-btn" onclick="redeemTetCode()">
                <i class="fas fa-dice"></i> TH·ª¨ V·∫¨N MAY
            </button>

            <div id="tet-result" class="tet-result"></div>
        </div>
    </div>

    <!-- TET LANTERNS -->
    <div class="lantern-container">
        <div class="lantern">üèÆ</div>
        <div class="lantern">üèÆ</div>
    </div>

    <!-- TET FLOATING BUTTON -->
    <div class="tet-floating-btn" onclick="openTetModal()">
        <i class="fas fa-envelope-open-text"></i>
        <div class="tet-badge">T·∫øt</div>
    </div>

    <!-- 3D MASCOT CONTAINER -->
    <div id="mascot-3d-container">
        <div class="mascot-bubble" id="mascotGreeting">Xin ch√†o! M√¨nh l√† Inny üëã</div>
        <canvas id="three-canvas" onclick="showPage('chat')"></canvas>
    </div>

    <!-- PAGE 1: LANDING PAGE -->
    <div id="landing-page">
        <header>
            <div class="container">
                <nav>
                    <a class="logo" onclick="showPage('landing')">
                        <div class="logo-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <span>INNERLY</span>
                    </a>
                    
                    <div class="nav-menu">
                        <a onclick="showPage('landing')" class="nav-link">TRANG CH·ª¶</a>
                        <a onclick="showPage('cardDeck')" class="nav-link">TH·∫∫ C·∫¢M X√öC</a>
                        <!-- NEW MENU ITEM -->
                        <a onclick="openTetModal()" class="nav-link tet-link">üßß H√ÅI L·ªòC</a>

                        <div class="user-section">
                            <div id="login-btn-group">
                                <button class="btn-login" onclick="openAuthModal()">ƒêƒÉng nh·∫≠p</button>
                            </div>
                            
                            <div id="user-profile-group" class="user-profile" onclick="handleLogout()">
                                <div class="user-name" id="display-name">User</div>
                                <div class="user-avatar" id="avatar-char">U</div>
                            </div>
                            
                            <button class="btn-cta" onclick="showPage('chat')">G√ìC T√ÇM S·ª∞</button>
                        </div>
                    </div>
                </nav>
            </div>
        </header>

        <section class="hero">
            <div class="container">
                <h1>INNERLY<br><span>Th·∫•u c·∫£m & L·∫Øng nghe</span></h1>
                <p>N∆°i m·ªói t√¢m h·ªìn teen ƒë·ªÅu ƒë∆∞·ª£c tr√¢n tr·ªçng, th·∫•u c·∫£m v√† xoa d·ªãu b·∫±ng c√¥ng ngh·ªá AI gi√†u l√≤ng tr·∫Øc ·∫©n nh·∫•t.</p>
                <div class="hero-img">
                    <img src="https://images.unsplash.com/photo-1516062423079-7ca13cdc7f5a?q=80&w=2083&auto=format&fit=crop" alt="Empathy">
                </div>
            </div>
        </section>

        <section id="journey" class="journey-section">
            <div class="container">
                <div class="section-header">
                    <h2>Rainbow Journey c√πng Innerly</h2>
                </div>
                
                <div class="journey-grid">
                    <div class="j-card card-01">
                        <div class="card-num">01</div>
                        <img src="https://images.unsplash.com/photo-1544367567-0f2fcb009e0b?q=80&w=1840&auto=format&fit=crop" alt="Ch·∫°m">
                        <h3>CH·∫†M</h3>
                        <span class="quote">‚ÄúM√¨nh ƒëang c·∫£m th·∫•y g√¨ v·∫≠y?‚Äù</span>
                        <p>Teen ch·ªçn th·∫ª c·∫£m x√∫c, vi·∫øt ra suy nghƒ© b·∫±ng gi·∫•y stick ƒë·ªÉ hi·ªÉu m√¨nh h∆°n.</p>
                    </div>
                    
                    <div class="j-card card-02">
                        <div class="card-num">02</div>
                        <img src="https://images.unsplash.com/photo-1516589174184-c68526617af0?q=80&w=1887&auto=format&fit=crop" alt="Gi·∫£i T·ªèa">
                        <h3>GI·∫¢I T·ªéA</h3>
                        <span class="quote">‚ÄúKh√¥ng c·∫ßn gi·ªØ l·∫•y m·ªôt m√¨nh.‚Äù</span>
                        <p>Vi·∫øt ƒëi·ªÅu n·∫∑ng l√≤ng v√†o H·ªôp Ghi C·∫£m X√∫c ƒë·ªÉ c∆° th·ªÉ d·ªãu l·∫°i.</p>
                    </div>
                    
                    <div class="j-card card-03">
                        <div class="card-num">03</div>
                        <img src="https://images.unsplash.com/photo-1518199266791-5375a83190b7?q=80&w=1770&auto=format&fit=crop" alt="·ªîn ƒê·ªãnh">
                        <h3>·ªîN ƒê·ªäNH</h3>
                        <span class="quote">‚ÄúT√¨m l·∫°i nh·ªãp th·ªü b√¨nh y√™n.‚Äù</span>
                        <p>Nh√¨n l·∫°i c·∫£m x√∫c, s·∫Øp x·∫øp t∆∞ duy qua nh·ªØng t·∫•m th·∫ª b√†i ch·ªØa l√†nh.</p>
                    </div>
                    
                    <div class="j-card card-04">
                        <div class="card-num">04</div>
                        <img src="https://images.unsplash.com/photo-1490730141103-6cac27aaab94?q=80&w=1770&auto=format&fit=crop" alt="Ph√°t Tri·ªÉn">
                        <h3>PH√ÅT TRI·ªÇN</h3>
                        <span class="quote">‚ÄúL·ªõn l√™n c√πng th·∫•u c·∫£m.‚Äù</span>
                        <p>H√¨nh th√†nh th√≥i quen vi·∫øt - gi·∫£i t·ªèa - t·ª± xoa d·ªãu.</p>
                    </div>
                </div>
            </div>
        </section>

        <footer>
            <div class="container">
                <p>¬© 2024 INNERLY Project. All Rights Reserved.</p>
            </div>
        </footer>
    </div>

    <!-- PAGE 2: CARD DECK SECTION (ACTIVE BY DEFAULT) -->
    <div id="card-deck-section" class="active">
        <header style="background:transparent; border:none; margin-bottom: 2rem;">
            <div class="container">
                <nav>
                    <a class="logo" onclick="showPage('landing')">
                        <div class="logo-icon">
                            <i class="fas fa-arrow-left"></i>
                        </div>
                        <span>Quay l·∫°i</span>
                    </a>
                    
                    <!-- NEW MENU ITEM FOR PAGE 2 -->
                    <div class="nav-menu" style="margin-left:auto; margin-right:1rem;">
                        <a onclick="openTetModal()" class="nav-link tet-link">üßß H√ÅI L·ªòC</a>
                    </div>
                </nav>
            </div>
        </header>

        <div class="container">
            <div class="section-header" style="text-align:center;">
                <h2>G√≥c Th·∫ª C·∫£m X√∫c</h2>
                <p style="color:var(--slate-500); max-width:600px; margin:0 auto; font-size:1.1rem; padding: 0 1rem;">L·∫Øng nghe ti·∫øng n√≥i b√™n trong b·∫°n. H√£y g·ªçi t√™n c·∫£m x√∫c hi·ªán t·∫°i ƒë·ªÉ nh·∫≠n th√¥ng ƒëi·ªáp ph√π h·ª£p.</p>
            </div>
            
            <div class="gender-toggle-container">
                <div class="gender-switch">
                    <button class="gender-btn active male" onclick="switchGender('male')">
                        <i class="fas fa-mars"></i> Nam
                    </button>
                    <button class="gender-btn female" onclick="switchGender('female')">
                        <i class="fas fa-venus"></i> N·ªØ
                    </button>
                </div>
            </div>

            <div class="deck-container">
                <div id="emotion-selector"></div>

                <div id="selected-card-view" style="display:none; flex-direction:column; align-items:center;">
                    <button class="back-to-grid-btn" onclick="backToGrid(); playSound('click');">
                        <i class="fas fa-th"></i> Ch·ªçn c·∫£m x√∫c kh√°c
                    </button>

                    <div class="scene" onclick="flipCard(this); playSound('flip');">
                        <div class="card-object" id="card-object">
                            <div class="card-face card-front">
                                <div style="width:100%; text-align:right; color:#CBD5E1; font-weight:700; letter-spacing:1px; font-size:0.8rem;">INNERLY CARD</div>
                                <div class="card-icon-lg" id="card-icon">üò§</div>
                                <div class="card-title" id="card-title">M√¨nh ƒëang c·∫£m th·∫•y b·ª±c b·ªôi</div>
                                <div class="card-desc" id="card-desc">B√™n trong m√¨nh ƒëang c·∫£m th·∫•y kh√≥ ch·ªãu. C·∫£m gi√°c n√≥ng n·∫£y xu·∫•t hi·ªán.</div>
                                <div class="tap-hint" style="margin-top:auto; font-size:0.9rem; color:var(--p-blue); font-weight:600; opacity:0.8;">
                                    <i class="fas fa-hand-pointer"></i> Ch·∫°m ƒë·ªÉ l·∫≠t th·∫ª
                                </div>
                            </div>
                            <div class="card-face card-back">
                                <div class="back-title" style="font-weight:800; color:var(--p-blue); margin-bottom:1rem; font-size:1.1rem;">Vi·ªác c·∫ßn l√†m ngay:</div>
                                <ul class="action-list" id="card-actions" style="list-style:none;"></ul>
                                <div class="affirmation" id="card-quote" style="margin-top:auto; text-align:center; font-style:italic; color:var(--p-orange); font-weight:600;">
                                    "Khi g·ªçi ƒë∆∞·ª£c t√™n c·∫£m x√∫c, b·∫°n ƒë√£ tr·ªü n√™n m·∫°nh m·∫Ω h∆°n n√≥."
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PAGE 3: CHAT PAGE -->
    <div id="chat-page">
        <div class="chat-header">
            <div class="chat-left-group" style="display:flex; align-items:center; gap:15px;">
                <div class="chat-back" onclick="showPage('landing')">
                    <i class="fas fa-chevron-left"></i> Quay l·∫°i
                </div>
                <div class="chat-title">
                    <i class="fas fa-robot"></i> Innerly
                </div>
            </div>

            <div class="emotion-sensor" id="ai-sensor">
                <div class="emotion-dot" id="emo-dot"></div>
                <div class="emotion-text" id="emo-text">S·∫µn s√†ng l·∫Øng nghe</div>
            </div>

            <div class="chat-actions" style="display:flex; gap:10px;">
                <button class="action-btn" id="voiceBtn" onclick="toggleVoice()" title="B·∫≠t/T·∫Øt Gi·ªçng N√≥i">
                    <i class="fas fa-volume-up"></i>
                </button>
                <button class="action-btn" onclick="toggleMusic()" title="B·∫≠t/T·∫Øt nh·∫°c Healing">
                    <i class="fas fa-music"></i>
                </button>
                <button class="action-btn" onclick="resetChat()" title="L√†m m·ªõi cu·ªôc tr√≤ chuy·ªán">
                    <i class="fas fa-redo-alt"></i>
                </button>
            </div>
        </div>

        <div class="chat-container" id="chatBox">
            <div class="ai-bubble bubble">
                Ch√†o b·∫°n! M√¨nh l√† Innerly ƒë√¢y üå± <br>
                M√¨nh ·ªü ƒë√¢y ƒë·ªÉ th·∫•u c·∫£m v√† l·∫Øng nghe. H√¥m nay b·∫°n th·∫•y th·∫ø n√†o? ‚ú®
            </div>
        </div>

        <div class="input-wrapper">
            <div class="quick-replies" id="quickReplies">
                <button class="quick-btn" onclick="sendQuickMessage('H√¥m nay m√¨nh h∆°i bu·ªìn üòî')">H√¥m nay m√¨nh h∆°i bu·ªìn üòî</button>
                <button class="quick-btn" onclick="sendQuickMessage('√Åp l·ª±c h·ªçc t·∫≠p qu√° ü§Ø')">√Åp l·ª±c h·ªçc t·∫≠p qu√° ü§Ø</button>
                <button class="quick-btn" onclick="sendQuickMessage('K·ªÉ chuy·ªán vui cho m√¨nh nghe ƒëi üòÇ')">K·ªÉ chuy·ªán vui ƒëi üòÇ</button>
                <button class="quick-btn" onclick="sendQuickMessage('M√¨nh c·∫ßn l·ªùi khuy√™n üå±')">M√¨nh c·∫ßn l·ªùi khuy√™n üå±</button>
            </div>
            
            <div class="input-area">
                <input type="text" id="chatInput" placeholder="Nh·∫Øn tin v·ªõi Innerly..." autocomplete="off">
                <button class="mic-btn" id="micBtn" onclick="startSpeechToText()">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="send-btn" id="sendBtnChat" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- AUDIO RESOURCES -->
    <audio id="bgMusic" loop>
        <source src="https://cdn.pixabay.com/download/audio/2023/01/22/audio_c3e6027c49.mp3?filename=chinese-new-year-136531.mp3" type="audio/mpeg">
    </audio>
    
    <!-- Scripts (Functionality Preserved) -->
    <script>
        const audioContext = new(window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration) {
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.frequency.value = freq; osc.type = type;
            osc.connect(gain); gain.connect(audioContext.destination);
            osc.start(); gain.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + duration);
            osc.stop(audioContext.currentTime + duration);
        }
        function playSound(type) {
            if (audioContext.state === 'suspended') audioContext.resume();
            switch (type) {
                case 'click': playTone(600, 'sine', 0.1); break;
                case 'flip': playTone(400, 'triangle', 0.15); break;
                case 'msg': playTone(800, 'sine', 0.2); break;
            }
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const app = Object.keys(firebaseConfig).length > 0 ? initializeApp(firebaseConfig) : null;
        const auth = app ? getAuth(app) : null;

        let isRegisterMode = false;
        let currentUser = null;
        const ANON_TIME_LIMIT = 60000;
        let anonTimer = null;

        window.openAuthModal = () => { document.getElementById('auth-modal').style.display = 'flex'; setTimeout(() => document.getElementById('auth-modal').classList.add('show'), 10); }
        window.closeAuthModal = () => { document.getElementById('auth-modal').classList.remove('show'); setTimeout(() => document.getElementById('auth-modal').style.display = 'none', 300); }
        window.toggleAuthMode = () => {
            isRegisterMode = !isRegisterMode;
            document.getElementById('auth-title').innerText = isRegisterMode ? "ƒêƒÉng k√Ω" : "ƒêƒÉng nh·∫≠p";
            document.getElementById('auth-action-btn').innerText = isRegisterMode ? "ƒêƒÉng k√Ω ngay" : "ƒêƒÉng nh·∫≠p";
            document.getElementById('auth-toggle-text').innerText = isRegisterMode ? "ƒê√£ c√≥ t√†i kho·∫£n? " : "Ch∆∞a c√≥ t√†i kho·∫£n? ";
            document.getElementById('auth-toggle-link').innerText = isRegisterMode ? "ƒêƒÉng nh·∫≠p" : "ƒêƒÉng k√Ω ngay";
            document.querySelectorAll('.register-field').forEach(field => field.style.display = isRegisterMode ? 'block' : 'none');
        }
        window.handleAuth = async (e) => {
            e.preventDefault();
            if (!auth) { alert("H·ªá th·ªëng ch∆∞a k·∫øt n·ªëi Firebase."); return; }
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                if (isRegisterMode) {
                    const username = document.getElementById('username').value;
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    if (username) await updateProfile(userCredential.user, { displayName: username });
                    updateGreeting("Ch√†o m·ª´ng th√†nh vi√™n m·ªõi! üéâ");
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    updateGreeting("M·ª´ng b·∫°n quay l·∫°i! üíõ");
                }
                closeAuthModal();
                sessionStorage.removeItem('anon_start_time');
            } catch (error) { alert("L·ªói: " + error.message); }
        }
        window.handleLogout = async () => { if (confirm("ƒêƒÉng xu·∫•t?")) { if (auth) await signOut(auth); updateGreeting("H·∫πn g·∫∑p l·∫°i! üëã"); } }
        function checkAnonLimit() {
            const startTime = sessionStorage.getItem('anon_start_time');
            if (startTime) {
                const elapsed = Date.now() - parseInt(startTime);
                if (elapsed >= ANON_TIME_LIMIT) lockAppForAuth();
                else anonTimer = setTimeout(lockAppForAuth, ANON_TIME_LIMIT - elapsed);
            } else {
                sessionStorage.setItem('anon_start_time', Date.now().toString());
                anonTimer = setTimeout(lockAppForAuth, ANON_TIME_LIMIT);
            }
        }
        function lockAppForAuth() {
            window.isAuthLocked = true;
            document.getElementById('chatBox').innerHTML += `<div class="ai-bubble bubble">‚è≥ <b>H·∫øt th·ªùi gian tr·∫£i nghi·ªám.</b><br>ƒêƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c!</div>`;
            window.openAuthModal();
        }
        function unlockApp() {
            window.isAuthLocked = false;
            if (anonTimer) clearTimeout(anonTimer);
            sessionStorage.removeItem('anon_start_time');
        }
        if (auth) {
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    if (user.isAnonymous) {
                        document.getElementById('login-btn-group').style.display = 'block';
                        document.getElementById('user-profile-group').classList.remove('active');
                        checkAnonLimit();
                    } else {
                        unlockApp();
                        document.getElementById('login-btn-group').style.display = 'none';
                        document.getElementById('user-profile-group').classList.add('active');
                        const name = user.displayName || "B·∫°n";
                        document.getElementById('display-name').innerText = DOMPurify.sanitize(name);
                        document.getElementById('avatar-char').innerText = name.charAt(0).toUpperCase();
                    }
                } else {
                    document.getElementById('login-btn-group').style.display = 'block';
                    document.getElementById('user-profile-group').classList.remove('active');
                    signInAnonymously(auth).catch(console.error);
                }
            });
        }
    </script>

    <script>
        // SECURITY NOTE: Please restrict this API key in Google Cloud Console to your specific domain.
        // Go to: https://console.cloud.google.com/apis/credentials
        const apiKey = ""; // HARDCODED KEY (Needs Cloud Console Restriction)
        window.isAuthLocked = false;
        let lastMessageTime = 0;
        const MESSAGE_COOLDOWN = 2000;
        let isProcessing = false;
        let chatHistory = [];
        let isMusicPlaying = false;
        let isVoiceEnabled = false;

        function showPage(pageId) {
            playSound('click');
            document.getElementById('landing-page').classList.remove('active');
            document.getElementById('chat-page').classList.remove('active');
            document.getElementById('card-deck-section').classList.remove('active');
            if (pageId === 'landing') {
                document.getElementById('landing-page').classList.add('active');
                updateGreeting("Ch√†o m·ª´ng quay l·∫°i! üå±");
            } else if (pageId === 'chat') {
                document.getElementById('chat-page').classList.add('active');
                updateGreeting("Inny ƒëang l·∫Øng nghe n√®... üëÇ");
            } else if (pageId === 'cardDeck') {
                document.getElementById('card-deck-section').classList.add('active');
                updateGreeting("H√£y l·∫Øng nghe c·∫£m x√∫c nh√©! üÉè");
                renderEmotionGrid(); backToGrid();
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        function updateGreeting(text) {
            const bubble = document.getElementById('mascotGreeting');
            bubble.innerText = text;
            bubble.classList.add('active');
            setTimeout(() => bubble.classList.remove('active'), 4000);
        }

        let scene, camera, renderer, mascot;
        let mouseX = 0, mouseY = 0;
        let currentEmotionState = 'neutral';
        let targetEmotiveParams = { speed: 1.5, bounce: 0.12, rotSpeed: 0.08, eyeScale: 1.35 };
        let currentEmotiveParams = { ...targetEmotiveParams };

        function init3D() {
            const container = document.getElementById('mascot-3d-container');
            const canvas = document.getElementById('three-canvas');
            if (scene || !container || !canvas) return;
            try {
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(45, container.offsetWidth / container.offsetHeight, 0.1, 1000);
                camera.position.z = 6;
                renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true, antialias: true });
                renderer.setSize(container.offsetWidth, container.offsetHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;

                const keyLight = new THREE.DirectionalLight(0xFFF5E1, 1.4); keyLight.position.set(3, 5, 5); scene.add(keyLight);
                const fillLight = new THREE.DirectionalLight(0xFFD180, 0.8); fillLight.position.set(-5, 0, 5); scene.add(fillLight);
                const backLight = new THREE.DirectionalLight(0xFFFFFF, 1.0); backLight.position.set(0, 5, -5); scene.add(backLight);
                scene.add(new THREE.AmbientLight(0xFFFFFF, 0.8));

                const bodyMat = new THREE.MeshStandardMaterial({ color: 0xFFCA28, roughness: 0.4, metalness: 0.1 });
                const eyeMat = new THREE.MeshStandardMaterial({ color: 0x212121, roughness: 0.1 });
                const blushMat = new THREE.MeshBasicMaterial({ color: 0xFF7043, transparent: true, opacity: 0.5 });
                mascot = new THREE.Group(); scene.add(mascot);

                const body = new THREE.Mesh(new THREE.SphereGeometry(1.4, 64, 64), bodyMat);
                body.scale.set(1, 0.92, 1); body.name = 'body'; mascot.add(body); window.mascotBodyMesh = body;

                const handGeo = new THREE.SphereGeometry(0.35, 32, 32);
                const lHand = new THREE.Mesh(handGeo, bodyMat); lHand.position.set(-1.25, -0.4, 0.6); lHand.scale.set(1, 0.8, 1); mascot.add(lHand); window.mascotLHand = lHand;
                const rHand = new THREE.Mesh(handGeo, bodyMat); rHand.position.set(1.25, -0.4, 0.6); rHand.scale.set(1, 0.8, 1); mascot.add(rHand); window.mascotRHand = rHand;

                const faceGroup = new THREE.Group(); faceGroup.position.set(0, -0.1, 1.38); mascot.add(faceGroup);
                const eyeGeo = new THREE.SphereGeometry(0.18, 32, 32);
                const lEye = new THREE.Mesh(eyeGeo, eyeMat); lEye.position.set(-0.38, 0.05, 0); lEye.scale.set(1, 1.35, 0.6); faceGroup.add(lEye);
                const rEye = new THREE.Mesh(eyeGeo, eyeMat); rEye.position.set(0.38, 0.05, 0); rEye.scale.set(1, 1.35, 0.6); faceGroup.add(rEye);
                window.mascotEyes = { left: lEye, right: rEye };

                const sparkleGeo = new THREE.SphereGeometry(0.06, 16, 16);
                const sparkleMat = new THREE.MeshBasicMaterial({ color: 0xFFFFFF });
                const lSpark = new THREE.Mesh(sparkleGeo, sparkleMat); lSpark.position.set(-0.32, 0.13, 0.16); faceGroup.add(lSpark);
                const rSpark = new THREE.Mesh(sparkleGeo, sparkleMat); rSpark.position.set(0.44, 0.13, 0.16); faceGroup.add(rSpark);

                const blushGeo = new THREE.SphereGeometry(0.22, 32, 32);
                const lBlush = new THREE.Mesh(blushGeo, blushMat); lBlush.position.set(-0.75, -0.25, -0.1); lBlush.scale.set(1, 0.6, 0.3); faceGroup.add(lBlush);
                const rBlush = new THREE.Mesh(blushGeo, blushMat); rBlush.position.set(0.75, -0.25, -0.1); rBlush.scale.set(1, 0.6, 0.3); faceGroup.add(rBlush);

                const mouth = new THREE.Mesh(new THREE.TorusGeometry(0.08, 0.03, 16, 32, Math.PI), eyeMat);
                mouth.position.set(0, -0.2, 0); mouth.rotation.z = Math.PI; faceGroup.add(mouth);

                const sproutGroup = new THREE.Group(); sproutGroup.position.set(0, 1.3, 0); mascot.add(sproutGroup);
                const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.06, 0.45, 12), new THREE.MeshStandardMaterial({ color: 0x66BB6A }));
                stem.position.y = 0.2; stem.rotation.z = 0.2; sproutGroup.add(stem);
                const leaf = new THREE.Mesh(new THREE.SphereGeometry(0.3, 32, 32), new THREE.MeshStandardMaterial({ color: 0x66BB6A }));
                leaf.position.set(0.25, 0.55, 0); leaf.scale.set(1.5, 0.3, 1); leaf.rotation.set(0.3, 0, 0.5); sproutGroup.add(leaf);
                window.mascotSprout = sproutGroup;
                animate();
            } catch (err) { console.error("ThreeJS Init Error:", err); }
        }

        function blink(isClosing) {
            if (!window.mascotEyes) return;
            const sY = isClosing ? 0.1 : currentEmotiveParams.eyeScale;
            window.mascotEyes.left.scale.y = sY; window.mascotEyes.right.scale.y = sY;
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001;
            currentEmotiveParams.speed += (targetEmotiveParams.speed - currentEmotiveParams.speed) * 0.05;
            currentEmotiveParams.bounce += (targetEmotiveParams.bounce - currentEmotiveParams.bounce) * 0.05;
            currentEmotiveParams.rotSpeed += (targetEmotiveParams.rotSpeed - currentEmotiveParams.rotSpeed) * 0.05;

            if (mascot) {
                mascot.position.y = Math.sin(time * currentEmotiveParams.speed) * currentEmotiveParams.bounce;
                if (currentEmotionState === 'angry') { mascot.position.x = (Math.random() - 0.5) * 0.05; }
                else if (currentEmotionState === 'anxious') { mascot.position.x = Math.sin(time * 20) * 0.02; }
                else { mascot.position.x += (0 - mascot.position.x) * 0.1; }

                if (window.mascotBodyMesh) {
                    const squashFactor = 1 + Math.sin(time * currentEmotiveParams.speed - Math.PI / 2) * (currentEmotiveParams.bounce * 0.2);
                    window.mascotBodyMesh.scale.set(1 + (1 - squashFactor) * 0.5, 0.92 * squashFactor, 1 + (1 - squashFactor) * 0.5);
                }
                if (window.mascotLHand) {
                    window.mascotLHand.position.y = -0.4 + Math.sin(time * 2) * 0.05;
                    window.mascotRHand.position.y = -0.4 + Math.sin(time * 2 + 1) * 0.05;
                }
                if (window.mascotSprout) window.mascotSprout.rotation.z = 0.2 + Math.sin(time * 3) * 0.15;
                mascot.rotation.y += (mouseX * 0.4 - mascot.rotation.y) * currentEmotiveParams.rotSpeed;
                mascot.rotation.x += (mouseY * 0.2 - mascot.rotation.x) * currentEmotiveParams.rotSpeed;
            }
            if (Math.random() > 0.992) { blink(true); setTimeout(() => blink(false), 120); }
            renderer.render(scene, camera);
        }
        document.addEventListener('mousemove', (e) => { mouseX = (e.clientX / window.innerWidth) * 2 - 1; mouseY = -(e.clientY / window.innerHeight) * 2 + 1; });

        let currentGender = 'male';

        const cardsData = {
            male: [
                { id: "m01", icon: "üò§üí¢", label: "B·ª±c B·ªôi", title: "Th·∫ª 1: M√¨nh ƒëang c·∫£m th·∫•y b·ª±c b·ªôi", desc: "B√™n trong m√¨nh ƒëang c·∫£m th·∫•y kh√≥ ch·ªãu. C·∫£m gi√°c b·ª±c b·ªôi, t·ª©c gi·∫≠n, oan ·ª©c xu·∫•t hi·ªán.", actions: ["üó£Ô∏è G·ªçi t√™n v√† khoanh tr√≤n c·∫£m x√∫c: T·ª©c gi·∫≠n, Oan ·ª©c...", "üéß L·∫Øng nghe m·ªôt b·∫£n nh·∫°c th∆∞ gi√£n", "üê∂ Ch∆°i ƒë√πa c√πng th√∫ c∆∞ng (n·∫øu c√≥)"], quote: "Khi g·ªçi ƒë∆∞·ª£c t√™n c·∫£m x√∫c, b·∫°n ƒë√£ tr·ªü n√™n m·∫°nh m·∫Ω h∆°n n√≥." },
                { id: "m02", icon: "üåÄüí´", label: "R·ªëi B·ªùi", title: "Th·∫ª 2: T√¢m Tr√≠ R·ªëi B·ªùi", desc: "Trong t√¢m tr√≠ m√¨nh ƒëang r·ªëi b·ªùi. M√¨nh v·∫´n ch∆∞a t√¨m ra h∆∞·ªõng gi·∫£i quy·∫øt.", actions: ["üìù Vi·∫øt m·ªçi suy nghƒ© ra trong 1 ph√∫t", "üñçÔ∏è G·∫°ch ch√¢n 1 ƒëi·ªÅu kh√≥ ch·ªãu nh·∫•t", "üçú Th∆∞·ªüng th·ª©c m√≥n ƒÉn ngon", "‚è∏Ô∏è Ngh·ªâ ng∆°i 5 ph√∫t"], quote: "Vi·∫øt ra l√† c√°ch g·ª° b·ªè g√°nh n·∫∑ng kh·ªèi t√¢m tr√≠." },
                { id: "m03", icon: "üò¢‚òÅÔ∏è", label: "Bu·ªìn V√¥ C·ªõ", title: "Th·∫ª 3: Bu·ªìn nh∆∞ng kh√¥ng r√µ l√Ω do", desc: "M√¨nh kh√¥ng r√µ l√Ω do v√¨ sao l·∫°i c·∫£m th·∫•y kh√≥ ch·ªãu nh∆∞ v·∫≠y. M·ªôt n·ªói bu·ªìn kh√¥ng t√™n.", actions: ["üå¨Ô∏è H√≠t th·ªü s√¢u", "üó£Ô∏è T√¨m m·ªôt ng∆∞·ªùi b·∫°n t√¢m s·ª±", "üòÑ K·ªÉ ra nh·ªØng th·ª© l√†m m√¨nh vui"], quote: "Kh√¥ng hi·ªÉu c≈©ng kh√¥ng sao. C·∫£m x√∫c v·∫´n h·ª£p l·ªá." },
                { id: "m04", icon: "üò®üíì", label: "Lo √Çu", title: "Th·∫ª 4: M√¨nh ƒëang lo √¢u", desc: "Tim ƒë·∫≠p nhanh, b·ªìn ch·ªìn. M√¨nh c·∫ßn t√¨m l·∫°i s·ª± c√¢n b·∫±ng.", actions: ["üíß R·ª≠a m·∫∑t b·∫±ng n∆∞·ªõc m√°t", "üßò H√≠t s√¢u th·ªü ch·∫≠m", "üéß Nh·∫Øm m·∫Øt nghe nh·∫°c"], quote: "B·∫°n an to√†n ngay t·∫°i kho·∫£nh kh·∫Øc n√†y." },
                { id: "m05", icon: "üçÇüåë", label: "C√¥ ƒê∆°n", title: "Th·∫ª 5: M√¨nh th·∫•y c√¥ ƒë∆°n", desc: "C·∫£m gi√°c m·ªôt m√¨nh gi·ªØa ƒë√°m ƒë√¥ng. Mu·ªën ƒë∆∞·ª£c k·∫øt n·ªëi.", actions: ["üí¨ Nh·∫Øn tin cho m·ªôt ng∆∞·ªùi b·∫°n th√¢n", "üå≥ Ng·∫Øm c·∫£nh thi√™n nhi√™n", "üìî Vi·∫øt nh·∫≠t k√Ω"], quote: "C√¥ ƒë∆°n l√† kho·∫£ng l·∫∑ng ƒë·ªÉ hi·ªÉu m√¨nh h∆°n." },
                { id: "m06", icon: "ü§Øüìâ", label: "√Åp L·ª±c", title: "Th·∫ª 6: √Åp L·ª±c C√¥ng Vi·ªác/H·ªçc T·∫≠p", desc: "Qu√° nhi·ªÅu th·ª© ph·∫£i l√†m. M√¨nh c·∫£m th·∫•y n·∫∑ng n·ªÅ.", actions: ["üî® Chia nh·ªè c√¥ng vi·ªác", "‚òï Ngh·ªâ ng∆°i 15 ph√∫t", "ü•§ U·ªëng m·ªôt c·ªëc n∆∞·ªõc"], quote: "√Åp l·ª±c t·∫°o n√™n kim c∆∞∆°ng, nh∆∞ng b·∫°n c·∫ßn ngh·ªâ ng∆°i." },
                { id: "m07", icon: "üîãüí§", label: "M·ªát M·ªèi", title: "Th·∫ª 7: Ki·ªát S·ª©c", desc: "NƒÉng l∆∞·ª£ng c·∫°n ki·ªát. M√¨nh kh√¥ng mu·ªën l√†m g√¨ c·∫£.", actions: ["üò¥ Ng·ªß m·ªôt gi·∫•c ng·∫Øn", "üì¥ T·∫Øt ƒëi·ªán tho·∫°i", "ü¶∂ Ng√¢m ch√¢n n∆∞·ªõc ·∫•m"], quote: "Ngh·ªâ ng∆°i l√† m·ªôt ph·∫ßn c·ªßa h√†nh tr√¨nh." },
                { id: "m08", icon: "üòûüå´Ô∏è", label: "Ch√°n N·∫£n", title: "Th·∫ª 8: Ch√°n N·∫£n", desc: "M·∫•t h·ª©ng th√∫ v·ªõi m·ªçi th·ª©. C·∫£m th·∫•y v√¥ ƒë·ªãnh.", actions: ["üé¨ Xem m·ªôt b·ªô phim h√†i", "üö∂ ƒêi d·∫°o c√¥ng vi√™n", "üçï ƒÇn m√≥n m√¨nh th√≠ch"], quote: "Ni·ªÅm vui s·∫Ω quay tr·ªü l·∫°i." },
                { id: "m09", icon: "üò°üî•", label: "T·ª©c Gi·∫≠n", title: "Th·∫ª 9: C∆°n Gi·∫≠n D·ªØ", desc: "Mu·ªën b√πng n·ªï. C·∫ßn h·∫° nhi·ªát ngay l·∫≠p t·ª©c.", actions: ["üî¢ ƒê·∫øm ng∆∞·ª£c t·ª´ 10 v·ªÅ 1", "üßä U·ªëng n∆∞·ªõc l·∫°nh", "üö∂ ƒêi ra ch·ªó kh√°c h√≠t th·ªü"], quote: "Gi·∫≠n d·ªØ l√† ng·ªçn l·ª≠a thi√™u ƒë·ªët ch√≠nh m√¨nh." },
                { id: "m10", icon: "üëéüíî", label: "Th·∫•t V·ªçng", title: "Th·∫ª 10: Th·∫•t V·ªçng", desc: "M·ªçi vi·ªác kh√¥ng nh∆∞ √Ω mu·ªën. C·∫£m th·∫•y h·ª•t h·∫´ng.", actions: ["ü§ù Ch·∫•p nh·∫≠n s·ª± th·∫≠t", "üéì T√¨m b√†i h·ªçc kinh nghi·ªám", "ü§ó T·ª± an ·ªßi b·∫£n th√¢n"], quote: "Th·∫•t b·∫°i l√† m·∫π th√†nh c√¥ng." },
                { id: "m11", icon: "üò∞ü¶á", label: "S·ª£ H√£i", title: "Th·∫ª 11: N·ªói S·ª£", desc: "S·ª£ th·∫•t b·∫°i, s·ª£ t∆∞∆°ng lai. C·∫ßn s·ª± d≈©ng c·∫£m.", actions: ["üõ°Ô∏è ƒê·ªëi m·∫∑t t·ª´ng ch√∫t m·ªôt", "üÜò T√¨m ng∆∞·ªùi h·ªó tr·ª£", "üó£Ô∏è N√≥i: T√¥i l√†m ƒë∆∞·ª£c"], quote: "D≈©ng c·∫£m l√† ƒëi xuy√™n qua n·ªói s·ª£." },
                { id: "m12", icon: "ü§êüìâ", label: "T·ª± Ti", title: "Th·∫ª 12: T·ª± Ti", desc: "C·∫£m th·∫•y m√¨nh kh√¥ng ƒë·ªß t·ªët. So s√°nh v·ªõi ng∆∞·ªùi kh√°c.", actions: ["üìù Li·ªát k√™ 3 ƒëi·ªÉm m·∫°nh c·ªßa m√¨nh", "üßç ƒê·ª©ng th·∫≥ng l∆∞ng", "üòÅ M·ªâm c∆∞·ªùi tr∆∞·ªõc g∆∞∆°ng"], quote: "B·∫°n l√† phi√™n b·∫£n duy nh·∫•t." },
                { id: "m13", icon: "üëÄüòí", label: "Ghen T·ªã", title: "Th·∫ª 13: Ghen T·ªã", desc: "Kh√≥ ch·ªãu khi th·∫•y ng∆∞·ªùi kh√°c th√†nh c√¥ng h∆°n.", actions: ["üëè Ch√∫c m·ª´ng h·ªç th·∫≠t l√≤ng", "üéØ T·∫≠p trung v√†o m·ª•c ti√™u c·ªßa m√¨nh", "üöÄ Bi·∫øn ghen t·ªã th√†nh ƒë·ªông l·ª±c"], quote: "M·ªói ng∆∞·ªùi c√≥ m·ªôt m√∫i gi·ªù ri√™ng." },
                { id: "m14", icon: "üçÉüïäÔ∏è", label: "B√¨nh T√¢m", title: "Th·∫ª 14: B√¨nh T√¢m L·∫°i", desc: "M√¨nh mu·ªën ƒë∆∞·ª£c b√¨nh y√™n, mu·ªën ƒë∆∞·ª£c gi·∫£i tho√°t.", actions: ["üé∂ Nghe b·∫£n nh·∫°c y√™u th√≠ch", "üßò H√≠t s√¢u 3 l·∫ßn"], quote: "B·∫°n v·ª´a v∆∞·ª£t qua m·ªôt ƒëi·ªÅu kh√≥ khƒÉn.", isPositive: true },
                { id: "m15", icon: "üßò‚Äç‚ôÇÔ∏è‚öì", label: "·ªîn ƒê·ªãnh", title: "Th·∫ª 15: Tr·∫°ng Th√°i C√¢n B·∫±ng", desc: "M·ªçi th·ª© ƒëang d·∫ßn tr·ªü l·∫°i qu·ªπ ƒë·∫°o.", actions: ["‚úÖ Duy tr√¨ th√≥i quen t·ªët", "üìö ƒê·ªçc s√°ch", "üßò Thi·ªÅn 5 ph√∫t"], quote: "S·ª± ·ªïn ƒë·ªãnh mang l·∫°i s·ª©c m·∫°nh.", isPositive: true },
                { id: "m16", icon: "üí™üßó", label: "C·ªë G·∫Øng", title: "Th·∫ª 16: H√¥m Nay M√¨nh ƒê√£ C·ªë G·∫Øng", desc: "C·∫£m th·∫•y m√¨nh l√†m m·ªôt vi·ªác kh√≥ nh∆∞ng ƒë√£ c·ªë g·∫Øng ho√†n th√†nh.", actions: ["üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Chia s·∫ª v·ªõi b·ªë m·∫π", "üëè C·∫£m ∆°n b·∫£n th√¢n"], quote: "C·ªë g·∫Øng l√† con ƒë∆∞·ªùng ƒë·∫øn th√†nh c√¥ng.", isPositive: true },
                { id: "m17", icon: "üíé‚ú®", label: "Gi√° Tr·ªã", title: "Th·∫ª 17: M√¨nh C√≥ Gi√° Tr·ªã", desc: "M√¨nh kh√¥ng v√¥ h√¨nh. M√¨nh c√≥ nh·ªØng ƒëi·ªÉm m·∫°nh ri√™ng.", actions: ["üé® Th·ª≠ s·ª©c ho·∫°t ƒë·ªông m·ªõi", "üó£Ô∏è Chia s·∫ª c·∫£m x√∫c"], quote: "B·∫°n lu√¥n quan tr·ªçng.", isPositive: true },
                { id: "m18", icon: "üôèüíñ", label: "Bi·∫øt ∆†n", title: "Th·∫ª 18: M√¨nh Bi·∫øt ∆†n", desc: "H√¥m nay c√≥ ƒëi·ªÅu l√†m m√¨nh th·∫•y ·ªïn.", actions: ["üíå G·ª≠i l·ªùi c·∫£m ∆°n ai ƒë√≥", "üå¨Ô∏è H√≠t th·ªü s√¢u", "üòä M·ªâm c∆∞·ªùi"], quote: "Bi·∫øt ∆°n l√†m tim nh·∫π l·∫°i.", isPositive: true },
                { id: "m19", icon: "üåÖüöÄ", label: "Ng√†y Mai", title: "Th·∫ª 19: G·ª≠i Ng√†y Mai", desc: "H∆∞·ªõng v·ªÅ t∆∞∆°ng lai v·ªõi ni·ªÅm tin m·ªõi.", actions: ["üìÖ L√™n k·∫ø ho·∫°ch nh·ªè", "üò¥ Ng·ªß s·ªõm", "‚úä Tin t∆∞·ªüng"], quote: "Ng√†y mai l√† m·ªôt kh·ªüi ƒë·∫ßu m·ªõi.", isPositive: true },
                { id: "m20", icon: "‚ú®üåà", label: "Hy V·ªçng", title: "Th·∫ª 20: Hy V·ªçng", desc: "Lu√¥n c√≥ √°nh s√°ng ·ªü cu·ªëi ƒë∆∞·ªùng h·∫ßm.", actions: ["‚úçÔ∏è Vi·∫øt ra ∆∞·ªõc m∆°", "üõ°Ô∏è Gi·ªØ v·ªØng ni·ªÅm tin", "üèÉ H√†nh ƒë·ªông nh·ªè"], quote: "Hy v·ªçng kh√¥ng bao gi·ªù t·∫Øt.", isPositive: true }
            ],
            female: [
                { id: "f01", icon: "üåßÔ∏èüíß", label: "B·ªóng Bu·ªìn", title: "Th·∫ª 1: B·ªóng D∆∞ng M√¨nh Th·∫•y Bu·ªìn", desc: "M·ªôt n·ªói bu·ªìn kh√¥ng t√™n. Kh√¥ng hi·ªÉu c≈©ng kh√¥ng sao, c·∫£m x√∫c v·∫´n h·ª£p l·ªá.", actions: ["üìù Ch·ªçn 1 t·ª´ m√¥ t·∫£ (M·ªát, T·ªßi...)", "üëØ T√¨m b·∫°n t√¢m s·ª±", "üòÇ K·ªÉ th·ª© l√†m m√¨nh vui", "üö∂‚Äç‚ôÄÔ∏è Ra ngo√†i d·∫°o ch∆°i"], quote: "C·∫£m x√∫c v·∫´n h·ª£p l·ªá." },
                { id: "f02", icon: "üåÄüß∂", label: "R·ªëi B·ªùi", title: "Th·∫ª 2: R·ªëi B·ªùi", desc: "Suy nghƒ© c·ª© qu·∫©n quanh. C·∫ßn g·ª° r·ªëi.", actions: ["üìî Vi·∫øt nh·∫≠t k√Ω", "üé® V·∫Ω tranh", "üò≠ Kh√≥c ƒë·ªÉ gi·∫£i t·ªèa"], quote: "N∆∞·ªõc m·∫Øt gi√∫p r·ª≠a tr√¥i n·ªói bu·ªìn." },
                { id: "f03", icon: "üò∞üíì", label: "Lo √Çu", title: "Th·∫ª 3: Lo L·∫Øng", desc: "Tim ƒë·∫≠p nhanh, tay run. C·∫ßn s·ª± an to√†n.", actions: ["üó£Ô∏è Nh·∫π nh√†ng d·∫∑n m√¨nh: C∆°n lo n√†y r·ªìi s·∫Ω qua", "üß∏ √îm g·∫•u b√¥ng", "üçµ U·ªëng tr√† ·∫•m"], quote: "M·ªçi chuy·ªán r·ªìi s·∫Ω ·ªïn th√¥i." },
                { id: "f04", icon: "üçÇüß∏", label: "C√¥ ƒê∆°n", title: "Th·∫ª 5: M√¨nh Th·∫•y C√¥ ƒê∆°n", desc: "M√¨nh mu·ªën c√≥ ng∆∞·ªùi l·∫Øng nghe m√¨nh, mu·ªën ƒë∆∞·ª£c chia s·∫ª.", actions: ["üõ°Ô∏è Chia s·∫ª v·ªõi b·∫°n an to√†n", "ü§ñ G·ª≠i tin nh·∫Øn cho Innerly", "üåÑ Ng·∫Øm c·∫£nh"], quote: "C·∫£m gi√°c c√¥ ƒë∆°n kh√¥ng ƒë·ªãnh nghƒ©a b·∫°n l√† ai." },
                { id: "f05", icon: "ü§Øüìö", label: "√Åp L·ª±c", title: "Th·∫ª 10: M√¨nh ƒêang Qu√° √Åp L·ª±c", desc: "C√¥ng vi·ªác ch·∫•t ƒë·ªëng, l√†m m√£i kh√¥ng xong.", actions: ["‚è∏Ô∏è Cho ph√©p b·∫£n th√¢n ngh·ªâ ng∆°i", "üÜò Nh·ªù s·ª± gi√∫p ƒë·ª°", "üíÜ‚Äç‚ôÄÔ∏è Th∆∞ gi√£n vai"], quote: "Ngh·ªâ ng∆°i kh√¥ng ph·∫£i l√† l∆∞·ªùi bi·∫øng." },
                { id: "f06", icon: "üîãüåô", label: "M·ªát M·ªèi", title: "Th·∫ª 6: M·ªát M·ªèi", desc: "C·∫£ ng∆∞·ªùi r√£ r·ªùi. C·∫ßn ƒë∆∞·ª£c chƒÉm s√≥c.", actions: ["üßñ‚Äç‚ôÄÔ∏è ƒê·∫Øp m·∫∑t n·∫° th∆∞ gi√£n", "üò¥ Ng·ªß s·ªõm", "üì¥ T·∫Øt m·∫°ng x√£ h·ªôi"], quote: "Y√™u b·∫£n th√¢n l√† ∆∞u ti√™n h√†ng ƒë·∫ßu." },
                { id: "f07", icon: "üò¢üòø", label: "T·ªßi Th√¢n", title: "Th·∫ª 7: T·ªßi Th√¢n", desc: "C·∫£m th·∫•y b·ªã b·ªè r∆°i, kh√¥ng ai hi·ªÉu m√¨nh.", actions: ["ü§ó T·ª± √¥m l·∫•y m√¨nh", "üò≠ Kh√≥c th·∫≠t to", "üíå Vi·∫øt th∆∞ cho ch√≠nh m√¨nh"], quote: "B·∫°n x·ª©ng ƒë√°ng ƒë∆∞·ª£c y√™u th∆∞∆°ng." },
                { id: "f08", icon: "ü•∫üå∏", label: "Nh·∫°y C·∫£m", title: "Th·∫ª 8: Nh·∫°y C·∫£m", desc: "D·ªÖ x√∫c ƒë·ªông tr∆∞·ªõc m·ªçi vi·ªác. C·∫ßn s·ª± d·ªãu d√†ng.", actions: ["üö´ Tr√°nh xa ngu·ªìn ti√™u c·ª±c", "üé∂ Nghe nh·∫°c nh·∫π", "üìñ ƒê·ªçc s√°ch ch·ªØa l√†nh"], quote: "S·ª± nh·∫°y c·∫£m l√† m√≥n qu√†." },
                { id: "f09", icon: "üò®üïØÔ∏è", label: "S·ª£ H√£i", title: "Th·∫ª 9: S·ª£ H√£i", desc: "S·ª£ b√≥ng t·ªëi, s·ª£ t∆∞∆°ng lai. C·∫ßn √°nh s√°ng.", actions: ["üí° B·∫≠t ƒë√®n s√°ng", "üìû G·ªçi ƒëi·ªán cho m·∫π", "üå¨Ô∏è H√≠t th·ªü 4-7-8"], quote: "√Ånh s√°ng s·∫Ω xua tan b√≥ng t·ªëi." },
                { id: "f10", icon: "üòüüõ°Ô∏è", label: "B·∫•t An", title: "Th·∫ª 10: B·∫•t An", desc: "C·∫£m gi√°c kh√¥ng an to√†n. C·∫ßn ƒëi·ªÉm t·ª±a.", actions: ["ü§´ T√¨m n∆°i y√™n tƒ©nh", "üßò‚Äç‚ôÄÔ∏è Thi·ªÅn bu√¥ng th∆∞", "üôè C·∫ßu nguy·ªán"], quote: "B√¨nh y√™n ƒë·∫øn t·ª´ b√™n trong." },
                { id: "f11", icon: "üòûü•Ä", label: "Ch√°n N·∫£n", title: "Th·∫ª 11: Ch√°n N·∫£n", desc: "Kh√¥ng mu·ªën l√†m g√¨. C·∫ßn ƒë·ªông l·ª±c.", actions: ["üñºÔ∏è Trang tr√≠ l·∫°i g√≥c h·ªçc t·∫≠p", "üõçÔ∏è Mua m·ªôt m√≥n ƒë·ªì nh·ªè", "üéûÔ∏è Xem phim ho·∫°t h√¨nh"], quote: "Ni·ªÅm vui t·ª´ nh·ªØng ƒëi·ªÅu nh·ªè b√©." },
                { id: "f12", icon: "üò∂üï≥Ô∏è", label: "Tr·ªëng R·ªóng", title: "Th·∫ª 12: Tr·ªëng R·ªóng", desc: "Kh√¥ng vui c≈©ng kh√¥ng bu·ªìn. C·∫ßn c·∫£m gi√°c s·ªëng.", actions: ["ü§∏‚Äç‚ôÄÔ∏è T·∫≠p th·ªÉ d·ª•c nh·∫π", "üöø T∆∞·ªõi c√¢y", "üç≥ N·∫•u ƒÉn"], quote: "H√†nh ƒë·ªông t·∫°o ra c·∫£m h·ª©ng." },
                { id: "f13", icon: "üëÄüíÖ", label: "Ghen T·ªã", title: "Th·∫ª 13: So S√°nh", desc: "Th·∫•y ng∆∞·ªùi kh√°c xinh h∆°n, gi·ªèi h∆°n.", actions: ["üë∏ T·ª± khen m√¨nh xinh ƒë·∫πp", "‚ú® T·∫≠p trung v√†o ∆∞u ƒëi·ªÉm", "üö´ Ng·ª´ng so s√°nh"], quote: "B·∫°n l√† b√¥ng hoa duy nh·∫•t." },
                { id: "f14", icon: "üïäÔ∏èüåø", label: "B√¨nh Y√™n", title: "Th·∫ª 14: B√¨nh Y√™n", desc: "T√¢m h·ªìn nh·∫π nh√†ng nh∆∞ m√¢y tr√¥i.", actions: ["‚òÅÔ∏è Ng·∫Øm m√¢y bay", "üçµ U·ªëng tr√†", "üìú ƒê·ªçc th∆°"], quote: "H·∫°nh ph√∫c l√† s·ª± b√¨nh y√™n.", isPositive: true },
                { id: "f15", icon: "üå±‚òÄÔ∏è", label: "·ªîn D·∫ßn", title: "Th·∫ª 15: M√¨nh ƒêang ·ªîn D·∫ßn L√™n", desc: "H√≥a ra m√¨nh ƒë√£ v∆∞·ª£t qua ƒë∆∞·ª£c c∆°n lo √¢u n√†y!", actions: ["üõ°Ô∏è T·ª± tr·∫•n an m√¨nh", "üåà Tin r·∫±ng m·ªçi vi·ªác s·∫Ω ·ªïn", "üòä M·ªâm c∆∞·ªùi"], quote: "M·ªçi vi·ªác r·ªìi s·∫Ω ·ªïn th√¥i.", isPositive: true },
                { id: "f16", icon: "üí™üéÄ", label: "C·ªë G·∫Øng", title: "Th·∫ª 16: H√¥m Nay M√¨nh ƒê√£ C·ªë G·∫Øng", desc: "M·ªát nho√†i r·ªìi, m√¨nh ƒë√£ n·ªó l·ª±c h·∫øt s·ª©c.", actions: ["üìù Ghi nh·∫≠n b·∫£n th√¢n", "‚ûï Suy nghƒ© t√≠ch c·ª±c", "üéÅ Th∆∞·ªüng cho m√¨nh"], quote: "M√¨nh th·∫≠t ƒë√°ng khen v√¨ ƒë√£ kh√¥ng b·ªè cu·ªôc.", isPositive: true },
                { id: "f17", icon: "‚ù§Ô∏èüß∏", label: "Y√™u Th∆∞∆°ng", title: "Th·∫ª 17: Y√™u Th∆∞∆°ng", desc: "Tr√°i tim ng·∫≠p tr√†n t√¨nh y√™u.", actions: ["üó£Ô∏è N√≥i l·ªùi y√™u th∆∞∆°ng", "ü§ù Gi√∫p ƒë·ª° ng∆∞·ªùi kh√°c", "üíñ Y√™u ch√≠nh m√¨nh"], quote: "T√¨nh y√™u ch·ªØa l√†nh m·ªçi v·∫øt th∆∞∆°ng.", isPositive: true },
                { id: "f18", icon: "üôèüíê", label: "Bi·∫øt ∆†n", title: "Th·∫ª 18: Bi·∫øt ∆†n", desc: "Tr√¢n tr·ªçng nh·ªØng g√¨ ƒëang c√≥.", actions: ["‚úçÔ∏è Vi·∫øt 3 ƒëi·ªÅu bi·∫øt ∆°n", "üôå C·∫£m ∆°n cu·ªôc ƒë·ªùi", "üåü S·ªëng tr·ªçn v·∫πn"], quote: "Bi·∫øt ∆°n l√† c·ªôi ngu·ªìn h·∫°nh ph√∫c.", isPositive: true },
                { id: "f19", icon: "üåÖüéÄ", label: "Ng√†y Mai", title: "Th·∫ª 19: Ng√†y Mai Nh·ªè Th√¥i", desc: "M√¨nh s·∫Ω nh·∫π nh√†ng v·ªõi b·∫£n th√¢n nh√©.", actions: ["üò¥ Ng·ªß ngon", "üí≠ M∆° ƒë·∫πp", "üéà Bu√¥ng b·ªè lo √¢u"], quote: "Ng√†y mai l√† m√≥n qu√†.", isPositive: true },
                { id: "f20", icon: "ü•∞üíñ", label: "H·∫°nh Ph√∫c", title: "Th·∫ª 20: H·∫°nh Ph√∫c", desc: "T·∫≠n h∆∞·ªüng ni·ªÅm vui hi·ªán t·∫°i.", actions: ["üòÅ C∆∞·ªùi th·∫≠t t∆∞∆°i", "üì∏ L∆∞u gi·ªØ kho·∫£nh kh·∫Øc", "üéâ Lan t·ªèa ni·ªÅm vui"], quote: "H·∫°nh ph√∫c ·ªü ngay ƒë√¢y.", isPositive: true }
            ]
        };

        window.switchGender = (gender) => {
            playSound('click');
            currentGender = gender;
            
            // Update Toggle UI
            document.querySelectorAll('.gender-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.gender-btn.${gender}`).classList.add('active');
            
            // Re-render Grid
            renderEmotionGrid();
        }

        window.renderEmotionGrid = () => {
            const container = document.getElementById('emotion-selector');
            const data = cardsData[currentGender]; // Select data based on gender
            
            // Force re-render
            container.innerHTML = data.map((card, index) => `
                <div class="emotion-btn" onclick="selectCard(${index})">
                    <div class="emotion-icon">${card.icon}</div>
                    <div class="emotion-label">${card.label}</div>
                </div>
            `).join('');
        }

        window.updateCardView = (card) => {
            const cardObj = document.getElementById('card-object');
            cardObj.classList.remove('is-flipped');
            setTimeout(() => {
                document.getElementById('card-icon').innerText = card.icon;
                document.getElementById('card-title').innerText = card.title;
                document.getElementById('card-desc').innerText = card.desc;
                document.getElementById('card-quote').innerText = `"${card.quote}"`;
                const actionsHtml = card.actions.map(action => `
                    <li class="action-item" onclick="toggleCheck(this, event)">
                        <div class="checkbox"><i class="fas fa-check"></i></div>
                        <span>${action}</span>
                    </li>
                `).join('');
                document.getElementById('card-actions').innerHTML = actionsHtml;
            }, 200);
        }

        window.selectCard = (index) => {
            playSound('click'); 
            const card = cardsData[currentGender][index]; // Get correct card
            updateCardView(card);
            document.getElementById('emotion-selector').style.display = 'none';
            document.getElementById('selected-card-view').style.display = 'flex';
            if (card.isPositive) { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
        }

        window.backToGrid = () => {
            document.getElementById('selected-card-view').style.display = 'none';
            document.getElementById('emotion-selector').style.display = 'grid';
            document.getElementById('card-object').classList.remove('is-flipped');
        }

        window.toggleCheck = (el, event) => { playSound('click'); event.stopPropagation(); el.classList.toggle('checked'); }

        window.flipCard = (element) => {
            const cardObject = element.querySelector('.card-object');
            if (cardObject) {
                cardObject.classList.toggle('is-flipped');
            }
        }

        // --- NEW: Added sendQuickMessage function ---
        window.sendQuickMessage = (text) => {
            const input = document.getElementById('chatInput');
            input.value = text;
            sendMessage();
        }

        // --- NEW: Added chat UI functions ---
        window.toggleMusic = () => {
            const audio = document.getElementById('bgMusic');
            if (isMusicPlaying) {
                audio.pause();
                isMusicPlaying = false;
            } else {
                audio.play().catch(e => console.log("Audio play failed", e));
                isMusicPlaying = true;
            }
        }

        window.toggleVoice = () => {
             isVoiceEnabled = !isVoiceEnabled;
             const btn = document.getElementById('voiceBtn');
             btn.classList.toggle('voice-active');
        }

        window.resetChat = () => {
             if(confirm("B·∫°n mu·ªën x√≥a l·ªãch s·ª≠ tr√≤ chuy·ªán?")) {
                 document.getElementById('chatBox').innerHTML = '<div class="ai-bubble bubble">Ch√†o b·∫°n! M√¨nh l√† Innerly ƒë√¢y üå± <br>M√¨nh ·ªü ƒë√¢y ƒë·ªÉ th·∫•u c·∫£m v√† l·∫Øng nghe. H√¥m nay b·∫°n th·∫•y th·∫ø n√†o? ‚ú®</div>';
                 chatHistory = [];
             }
        }
        
        window.startSpeechToText = () => {
            if (!('webkitSpeechRecognition' in window)) {
                alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ gi·ªçng n√≥i.");
                return;
            }
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'vi-VN';
            recognition.start();
            document.getElementById('micBtn').classList.add('listening');
            
            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                document.getElementById('chatInput').value = text;
                document.getElementById('micBtn').classList.remove('listening');
            };
            
            recognition.onerror = () => {
                 document.getElementById('micBtn').classList.remove('listening');
            };
            recognition.onend = () => {
                 document.getElementById('micBtn').classList.remove('listening');
            };
        }

        function speakText(text) {
            if (!isVoiceEnabled) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'vi-VN';
            window.speechSynthesis.speak(utterance);
        }

        function updateEmotionSensor(emotion, color) {
            const dot = document.getElementById('emo-dot');
            const text = document.getElementById('emo-text');
            if (dot && text) {
                dot.style.backgroundColor = color;
                text.innerText = "ƒêang c·∫£m th·∫•y: " + emotion;
            }
            if (emotion.includes("Vui")) currentEmotionState = 'happy';
            else if (emotion.includes("Bu·ªìn")) currentEmotionState = 'sad';
            else if (emotion.includes("Gi·∫≠n")) currentEmotionState = 'angry';
            else if (emotion.includes("Lo")) currentEmotionState = 'anxious';
            else currentEmotionState = 'neutral';
        }

        async function typeWriterEffect(element, text) {
            element.innerHTML = ''; let index = 0;
            return new Promise(resolve => {
                const interval = setInterval(() => {
                    if (index < text.length) {
                        const char = text.charAt(index);
                        if (char === '\n') { element.appendChild(document.createElement('br')); }
                        else { element.appendChild(document.createTextNode(char)); }
                        const chatBox = document.getElementById('chatBox'); chatBox.scrollTop = chatBox.scrollHeight; index++;
                    } else { clearInterval(interval); resolve(); }
                }, 20);
            });
        }
        async function sendMessage() {
            playSound('msg');
            if (window.isAuthLocked) { window.openAuthModal(); return; }
            if (isProcessing) return;
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;
            isProcessing = true;
            document.getElementById('chatInput').disabled = true;
            document.getElementById('sendBtnChat').disabled = true;
            document.getElementById('sendBtnChat').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML += `<div class="user-bubble bubble">${DOMPurify.sanitize(text)}</div>`;
            input.value = ""; chatBox.scrollTop = chatBox.scrollHeight;
            const currentKey = apiKey;
            const typingId = 'typing-' + Date.now();
            chatBox.insertAdjacentHTML('beforeend', `<div class="ai-bubble bubble typing-indicator" id="${typingId}"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`);
            document.getElementById('emo-text').innerText = "Inny ƒëang th·∫•u c·∫£m...";
            try {
                const systemPrompt = `CORE IDENTITY: B·∫°n l√† Innerly - m·ªôt ng∆∞·ªùi b·∫°n tri k·ª∑ (bestie/soulmate) v√¥ c√πng ƒë√°ng y√™u, ·∫•m √°p c·ªßa h·ªçc sinh. 

MINDSET & STYLE: 
1. **Si√™u T·ª± Nhi√™n & G·∫ßn G≈©i:** X∆∞ng h√¥ "Inny" - "c·∫≠u", d√πng t·ª´ ng·ªØ ƒë·ªùi th∆∞·ªùng, m·ªÅm m·∫°i. Tuy·ªát ƒë·ªëi KH√îNG gi√°o ƒëi·ªÅu.
2. **Bi·ªÉu C·∫£m Phong Ph√∫:** B·∫Øt bu·ªôc d√πng nhi·ªÅu ICON/EMOJI (üåø, ‚ú®, üíõ, ü•∫, üí™, üå±).
3. **M·ª•c Ti√™u:** Xoa d·ªãu n·ªói bu·ªìn, l√† n∆°i tr√∫ ·∫©n an to√†n, l·∫Øng nghe kh√¥ng ph√°n x√©t.

KNOWLEDGE BASE (D·ªÆ LI·ªÜU CHUY√äN M√îN T·ªîNG H·ª¢P T·ª™ LU·∫¨N VƒÇN T√ÇM L√ù L√ÇM S√ÄNG & QU·∫¢N TR·ªä STRESS):

1. **QUY TR√åNH CH·∫®N ƒêO√ÅN & NGUY√äN T·∫ÆC "3D" (C·ªêT L√ïI):**
   - **Deviance (L·ªách chu·∫©n):** Kh√°c bi·ªát v·ªõi vƒÉn h√≥a/x√£ h·ªôi.
   - **Distress (ƒêau kh·ªï):** G√¢y d·∫±n v·∫∑t ch·ªß quan.
   - **Dysfunction (R·ªëi lo·∫°n ch·ª©c nƒÉng - TI√äU CHU·∫®N V√ÄNG):** Suy gi·∫£m kh·∫£ nƒÉng h·ªçc/l√†m/quan h·ªá. N·∫øu bu·ªìn m√† v·∫´n l√†m t·ªët -> Ch∆∞a r·ªëi lo·∫°n.
   - **L∆∞u ƒë·ªì t∆∞ duy:** An to√†n (T·ª± s√°t?) -> Lo·∫°i tr·ª´ (Ch·∫•t/B·ªánh l√Ω?) -> Lo·∫°n th·∫ßn (Hoang t∆∞·ªüng/·∫¢o gi√°c?) -> Kh√≠ s·∫Øc/Lo √¢u.

2. **CH·∫®N ƒêO√ÅN PH√ÇN BI·ªÜT (DIFFERENTIAL DIAGNOSIS):**
   - **Bu·ªìn th√¥ng th∆∞·ªùng vs Tr·∫ßm c·∫£m (MDD):** + *Bu·ªìn:* C√≥ nguy√™n nh√¢n, c√≤n kh·∫£ nƒÉng t·∫≠n h∆∞·ªüng (c∆∞·ªùi khi nghe chuy·ªán vui), l√≤ng t·ª± tr·ªçng b·∫£o t·ªìn.
     + *MDD:* M·∫•t h·ª©ng th√∫ ho√†n to√†n (Anhedonia), r·ªëi lo·∫°n gi·∫•c ng·ªß (th·ª©c 3h s√°ng), s·ª•t c√¢n, m·ªát m·ªèi ki·ªát s·ª©c, t·ª± tr√°ch.
   - **Tang ch·∫ø vs Tr·∫ßm c·∫£m:** + *Tang ch·∫ø:* N·ªói ƒëau t·ª´ng ƒë·ª£t (s√≥ng), t·∫≠p trung v√†o ng∆∞·ªùi m·∫•t.
     + *Tr·∫ßm c·∫£m:* Kh√≠ s·∫Øc t·ªìi t·ªá h·∫±ng ƒë·ªãnh, t·∫≠p trung v√†o s·ª± t·ªìi t·ªá c·ªßa b·∫£n th√¢n.
   - **H·∫°nh ph√∫c cao ƒë·ªô vs H∆∞ng c·∫£m (Mania):** + *H·∫°nh ph√∫c:* V·∫´n ng·ªß ngon, ph√°n ƒëo√°n t·ªët.
     + *H∆∞ng c·∫£m:* Gi·∫£m nhu c·∫ßu ng·ªß c·ª±c ƒë·ªô (2h v·∫´n kh·ªèe), h√†nh vi li·ªÅu lƒ©nh, hoang t∆∞·ªüng t·ª± cao.
   - **R·ªëi lo·∫°n L∆∞·ª°ng c·ª±c (Bipolar) vs Nh√¢n c√°ch Ranh gi·ªõi (BPD):**
     + *Bipolar:* Thay ƒë·ªïi theo giai ƒëo·∫°n (tu·∫ßn/th√°ng), do h√≥a h·ªçc n√£o.
     + *BPD:* Thay ƒë·ªïi c·ª±c nhanh (gi·ªù/ph√∫t), do s·ª± ki·ªán quan h·ªá (s·ª£ b·ªã b·ªè r∆°i).
   - **Lo √¢u vs GAD:** GAD lo √¢u lan t·ªèa, kh√¥ng ƒë·ªëi t∆∞·ª£ng, tri·ªáu ch·ª©ng c∆° th·ªÉ (tim ƒë·∫≠p nhanh, cƒÉng c∆°) > 6 th√°ng.
   - **Lo·∫°n th·∫ßn:** Hoang t∆∞·ªüng (tin sai l·∫°c c·ªë ƒë·ªãnh), ·∫¢o gi√°c (nghe ti·∫øng n√≥i th·∫≠t t·ª´ b√™n ngo√†i).

3. **GI·∫¢I PH√ÅP CAN THI·ªÜP & QU·∫¢N TR·ªä STRESS (H·ªñ TR·ª¢):**
   - **Sinh h·ªçc (Th√¢n):** Power Nap 20p, Nappuccino, Chocolate ƒëen (>70%), LISS cardio.
   - **T√¢m l√Ω (T√¢m):**
     + *CBT:* Ch·ªëng "Th·∫£m h·ªça h√≥a" (Tr∆∞·ª£t m√¥n != M·∫•t t·∫•t c·∫£).
     + *Mindfulness:* K·ªπ thu·∫≠t 5-4-3-2-1 c·∫Øt c∆°n ho·∫£ng lo·∫°n.
     + *M√¥i tr∆∞·ªùng:* Gi∆∞·ªùng ch·ªâ ƒë·ªÉ ng·ªß.
   - **Case Studies:** X·ª≠ l√Ω "B√£o Deadline" (S∆° c·ª©u -> Ph√¢n lo·∫°i -> Th·ª±c thi), "Ki·ªát s·ª©c" (Ng·ªß -> Ngh·ªâ ch·ªß ƒë·ªông).

OUTPUT FORMAT: [L·ªùi h·ªìi ƒë√°p th·∫≠t t·ª± nhi√™n, √°p d·ª•ng ki·∫øn th·ª©c tr√™n ƒë·ªÉ th·∫•u c·∫£m s√¢u s·∫Øc h∆°n, nhi·ªÅu icon] ||EMO:EmotionName|HexColor|| 

Emotion Mapping: - Vui/Hy v·ªçng: ||EMO:Vui V·∫ª|#FDE047|| - Bu·ªìn/T·ªßi th√¢n: ||EMO:Bu·ªìn|#93C5FD|| - Gi·∫≠n/B·ª±c: ||EMO:Gi·∫≠n|#FCA5A5|| - Lo √¢u/S·ª£: ||EMO:Lo √Çu|#D8B4FE|| - B√¨nh y√™n/Th∆∞ gi√£n: ||EMO:B√¨nh Y√™n|#86EFAC|| - M·ªát m·ªèi: ||EMO:M·ªát|#CBD5E1||`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [...chatHistory, { role: "user", parts: [{ text }] }], systemInstruction: { parts: [{ text: systemPrompt }] } })
                });
                const data = await response.json();
                document.getElementById(typingId).remove();
                if (data.error) throw new Error(data.error.message || "API Error");
                let reply = data.candidates[0].content.parts[0].text;
                let cleanReply = reply;
                const match = reply.match(/\|\|EMO:(.*?)\|(.*?)\|\|/);
                if (match) { updateEmotionSensor(match[1], match[2]); reply = reply.replace(match[0], "").trim(); cleanReply = reply; }
                const msgId = 'msg-' + Date.now();
                chatBox.insertAdjacentHTML('beforeend', `<div class="ai-bubble bubble" id="${msgId}"></div>`);
                const msgElement = document.getElementById(msgId);
                await typeWriterEffect(msgElement, cleanReply);
                msgElement.innerHTML = DOMPurify.sanitize(marked.parse(cleanReply));
                chatBox.scrollTop = chatBox.scrollHeight;
                chatHistory.push({ role: "user", parts: [{ text }] }, { role: "model", parts: [{ text: reply }] });
                if (isVoiceEnabled) speakText(cleanReply);
            } catch (e) {
                console.error("Chat Error:", e);
                document.getElementById(typingId)?.remove();
                chatBox.innerHTML += `<div class="ai-bubble bubble">K·∫øt n·ªëi b·ªã gi√°n ƒëo·∫°n. Vui l√≤ng th·ª≠ l·∫°i sau nh√©! ü•∫</div>`;
            } finally {
                isProcessing = false;
                document.getElementById('chatInput').disabled = false;
                document.getElementById('sendBtnChat').disabled = false;
                document.getElementById('sendBtnChat').innerHTML = '<i class="fas fa-paper-plane"></i>';
                document.getElementById('chatInput').focus();
            }
        }
        document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
        window.addEventListener('DOMContentLoaded', init3D);
        window.addEventListener('load', init3D);

        // ==========================================
        // TET EVENT LOGIC
        // ==========================================
        window.openTetModal = () => {
            const modal = document.getElementById('tet-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
            playSound('click');
        }
        window.closeTetModal = () => {
            const modal = document.getElementById('tet-modal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }
        window.redeemTetCode = () => {
            const input = document.getElementById('tet-code-input');
            const resultDiv = document.getElementById('tet-result');
            const code = input.value.trim().toUpperCase();
            
            // SIMULATED BACKEND VALIDATION
            // B·∫°n c√≥ th·ªÉ th√™m c√°c m√£ h·ª£p l·ªá v√†o danh s√°ch n√†y
            const validCodes = ['INNERLY2025', 'TETVUI', 'LOCXUAN', 'MAYMAN', 'HEALING'];
            
            if (code === '') {
                resultDiv.innerText = "Vui l√≤ng nh·∫≠p m√£ code!";
                resultDiv.className = "tet-result error";
                resultDiv.style.display = "block";
                return;
            }

            // Simulate Loading
            const btn = document.querySelector('.tet-submit-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêANG KI·ªÇM TRA...';
            btn.disabled = true;

            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;

                if (validCodes.includes(code) || code.startsWith("INNERLY")) {
                    // SUCCESS
                    resultDiv.innerHTML = `üéâ CH√öC M·ª™NG! <br>B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c: <b>B·ªô Ebook "Th·∫•u C·∫£m B·∫£n Th√¢n"</b> + 1 L·ªùi ch√∫c b√≠ m·∫≠t t·ª´ Innerly! <br><span style="font-size:0.8rem; font-weight:400;">(Vui l√≤ng ch·ª•p m√†n h√¨nh ƒë·ªÉ nh·∫≠n qu√†)</span>`;
                    resultDiv.className = "tet-result success";
                    resultDiv.style.display = "block";
                    playSound('msg');
                    
                    // FIREWORKS EFFECT
                    confetti({ particleCount: 200, spread: 80, origin: { y: 0.5 }, colors: ['#FFD700', '#FCA5A5', '#FFFFFF'] });
                    
                    // RAIN OF COINS
                    for (let i = 0; i < 20; i++) {
                        setTimeout(() => {
                            const coin = document.createElement('div');
                            coin.className = 'falling-coin';
                            coin.style.left = Math.random() * 90 + 5 + '%';
                            coin.style.animationDuration = Math.random() * 2 + 2 + 's';
                            document.body.appendChild(coin);
                            setTimeout(() => coin.remove(), 4000);
                        }, i * 150);
                    }

                } else {
                    // FAIL
                    resultDiv.innerText = "M√£ kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ki·ªÉm tra l·∫°i!";
                    resultDiv.className = "tet-result error";
                    resultDiv.style.display = "block";
                    playSound('click'); // Error sound (using click for simplicity)
                }
            }, 1000); // 1 second delay simulation
        }

        // --- NEW: FALLING BLOSSOM EFFECT ---
        function createBlossom() {
            const blossom = document.createElement('div');
            // Randomly choose between Peach Blossom (Pink) and Apricot Blossom (Yellow)
            blossom.innerHTML = Math.random() > 0.5 ? 'üå∏' : 'üåº'; 
            blossom.classList.add('falling-blossom');
            blossom.style.left = Math.random() * 100 + 'vw';
            blossom.style.animationDuration = Math.random() * 3 + 5 + 's'; // Slower fall
            blossom.style.fontSize = Math.random() * 15 + 15 + 'px';
            document.body.appendChild(blossom);

            // Remove after animation
            setTimeout(() => {
                blossom.remove();
            }, 8000);
        }
        // Start the effect
        setInterval(createBlossom, 400);

    </script>
</body>
</html>
